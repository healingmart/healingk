<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ AllTourism Enterprise Test Dashboard v2.0</title>
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        :root {
            --primary-color: #2563eb;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
        }
        
        .diagnostic-panel {
            background: linear-gradient(135deg, #fee2e2, #fef3c7);
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .version-check {
            background: #1f2937;
            color: white;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            margin: 1rem 0;
        }
        
        .api-endpoint-display {
            background: rgba(37, 99, 235, 0.1);
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            border-left: 4px solid var(--primary-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ğŸš¨ ê¸´ê¸‰ ì§„ë‹¨ íŒ¨ë„ -->
        <div class="diagnostic-panel">
            <h2>ğŸ”§ ë²„ì „ ì§„ë‹¨ íŒ¨ë„</h2>
            <div class="alert alert-warning">
                <strong>âš ï¸ ì¤‘ìš”:</strong> ë¡œê·¸ì—ì„œ êµ¬ë²„ì „ API (KorService1) í˜¸ì¶œì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!
            </div>
            
            <div class="version-check">
                <h4>í˜„ì¬ ë°°í¬ëœ ë²„ì „ í™•ì¸:</h4>
                <div id="versionInfo">í™•ì¸ ì¤‘...</div>
            </div>
            
            <div class="api-endpoint-display">
                <h4>ì˜¬ë°”ë¥¸ API ì—”ë“œí¬ì¸íŠ¸:</h4>
                <code>https://apis.data.go.kr/B551011/KorService2/areaBasedList2</code>
            </div>
            
            <button class="btn btn-danger" onclick="diagnoseVersion()">
                ğŸ” ê¸´ê¸‰ ë²„ì „ ì§„ë‹¨
            </button>
            <button class="btn btn-warning" onclick="forceRefresh()">
                ğŸ”„ ê°•ì œ ìƒˆë¡œê³ ì¹¨
            </button>
        </div>

        <!-- ê¸°ì¡´ í—¤ë” ìˆ˜ì • -->
        <header class="header">
            <h1>ğŸš€ AllTourism Enterprise Test Dashboard v2.0</h1>
            <p>í•œêµ­ê´€ê´‘ê³µì‚¬ TourAPI 4.0 Enterprise - ë²„ì „ í™•ì¸ ë° ì§„ë‹¨</p>
            <div class="header-controls">
                <input type="url" class="api-url-input" id="apiUrl" 
                       placeholder="API ì„œë²„ URL ì…ë ¥" 
                       value="">
                <button class="btn btn-secondary" onclick="setApiUrl()">
                    ğŸ”— URL ì„¤ì •
                </button>
            </div>
        </header>

        <!-- ë‚˜ë¨¸ì§€ ê¸°ì¡´ ì½”ë“œ... -->
    </div>

    <script>
        // ğŸ”§ ê°œì„ ëœ JavaScript
        let API_BASE_URL = '';

        // ì´ˆê¸°í™” ì‹œ API URL ê°ì§€
        document.addEventListener('DOMContentLoaded', function() {
            detectApiUrl();
            diagnoseVersion();
        });

        // API URL ìë™ ê°ì§€
        function detectApiUrl() {
            const possibleUrls = [
                'https://healingk.vercel.app',
                window.location.origin,
                'http://localhost:3000',
                'http://localhost:8080'
            ];

            // ì²« ë²ˆì§¸ë¡œ ì‘ë‹µí•˜ëŠ” URL ì‚¬ìš©
            Promise.race(
                possibleUrls.map(url => 
                    fetch(`${url}/api/health`)
                        .then(res => res.ok ? url : Promise.reject())
                        .catch(() => Promise.reject())
                )
            ).then(workingUrl => {
                API_BASE_URL = workingUrl;
                document.getElementById('apiUrl').value = workingUrl;
                showAlert('success', `âœ… API ì„œë²„ ë°œê²¬: ${workingUrl}`);
            }).catch(() => {
                showAlert('error', 'âŒ ì‚¬ìš© ê°€ëŠ¥í•œ API ì„œë²„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            });
        }

        // ğŸ” ë²„ì „ ì§„ë‹¨ í•¨ìˆ˜
        async function diagnoseVersion() {
            try {
                showAlert('info', 'ğŸ” ì‹œìŠ¤í…œ ë²„ì „ì„ í™•ì¸ ì¤‘...');
                
                const response = await fetch(`${API_BASE_URL}/api/health`);
                const data = await response.json();
                
                const versionInfo = document.getElementById('versionInfo');
                versionInfo.innerHTML = `
                    <div>âœ… ì„œë²„ ì‘ë‹µ: ${response.status}</div>
                    <div>ğŸ“¦ ë²„ì „: ${data.version || 'Unknown'}</div>
                    <div>ğŸ—ï¸ í™˜ê²½: ${data.config?.environment || 'Unknown'}</div>
                    <div>ğŸ”‘ API í‚¤: ${data.config?.apiKeyConfigured ? 'YES' : 'NO'}</div>
                    <div>ğŸ›ï¸ ì»¨í…Œì´ë„ˆ: ${data.config ? 'Initialized' : 'Error'}</div>
                `;

                // ì‹¤ì œ API í…ŒìŠ¤íŠ¸
                await testActualApi();
                
            } catch (error) {
                document.getElementById('versionInfo').innerHTML = `
                    <div style="color: var(--error-color);">âŒ ë²„ì „ í™•ì¸ ì‹¤íŒ¨: ${error.message}</div>
                `;
            }
        }

        // ğŸ§ª ì‹¤ì œ API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
        async function testActualApi() {
            try {
                const testParams = {
                    operation: 'areaBasedList',
                    areaCode: '1',
                    numOfRows: '1'
                };

                const response = await fetch(`${API_BASE_URL}/api/tour?` + new URLSearchParams(testParams));
                const data = await response.json();
                
                if (data.success) {
                    showAlert('success', 'ğŸ‰ ìƒˆë¡œìš´ API (KorService2) í™•ì¸ë¨!');
                } else {
                    showAlert('error', `âŒ API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${data.error?.message}`);
                }
                
                // ê²°ê³¼ì— API ì—”ë“œí¬ì¸íŠ¸ ì •ë³´ í‘œì‹œ
                displayApiDiagnostic(data);
                
            } catch (error) {
                showAlert('error', `ğŸš¨ API í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        function displayApiDiagnostic(data) {
            const diagnostic = `
                <div class="result-item" style="border-left-color: var(--info-color);">
                    <h4>ğŸ” API ì—”ë“œí¬ì¸íŠ¸ ì§„ë‹¨ ê²°ê³¼</h4>
                    <div class="json-viewer">
{
  "diagnosis": {
    "expectedEndpoint": "https://apis.data.go.kr/B551011/KorService2/areaBasedList2",
    "apiResponse": ${data.success ? '"SUCCESS"' : '"FAILED"'},
    "timestamp": "${new Date().toISOString()}",
    "version": "${data.metadata?.version || 'Unknown'}",
    "serverType": "${data.success ? 'AllTourism Enterprise v2.0' : 'Legacy or Error'}"
  },
  "serverResponse": ${JSON.stringify(data, null, 2)}
}
                    </div>
                </div>
            `;
            
            document.getElementById('resultsContent').innerHTML = diagnostic + document.getElementById('resultsContent').innerHTML;
        }

        function setApiUrl() {
            const newUrl = document.getElementById('apiUrl').value;
            if (newUrl) {
                API_BASE_URL = newUrl;
                showAlert('info', `ğŸ”— API URL ë³€ê²½: ${newUrl}`);
                diagnoseVersion();
            }
        }

        function forceRefresh() {
            // ìºì‹œ ë¬´ì‹œí•˜ê³  í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            window.location.reload(true);
        }

        // ğŸ”§ ê°œì„ ëœ ì—ëŸ¬ ì²˜ë¦¬
        async function callAPI(endpoint, params = {}, method = 'GET') {
            if (!API_BASE_URL) {
                throw new Error('API ì„œë²„ URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            }

            const startTime = Date.now();
            
            try {
                showLoading(true);
                
                let url = `${API_BASE_URL}${endpoint}`;
                let options = {
                    method: method,
                    headers: {
                        'Accept': 'application/json',
                        'Accept-Language': currentLanguage,
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'  // ìºì‹œ ë°©ì§€
                    }
                };

                // GET ìš”ì²­ ì²˜ë¦¬
                if (method === 'GET') {
                    const urlObj = new URL(url);
                    Object.entries(params).forEach(([key, value]) => {
                        if (value !== null && value !== '' && value !== undefined) {
                            urlObj.searchParams.append(key, value);
                        }
                    });
                    url = urlObj.toString();
                } else {
                    options.body = JSON.stringify(params);
                }

                console.log('ğŸš€ API í˜¸ì¶œ:', { url, method, params });

                const response = await fetch(url, options);
                const data = await response.json();
                const responseTime = Date.now() - startTime;
                
                // ìƒì„¸ ë¡œê¹…
                console.log('ğŸ“¡ API ì‘ë‹µ:', { status: response.status, data, responseTime });

                if (data.success) {
                    displayResults(data, responseTime);
                    showAlert('success', `âœ… API í˜¸ì¶œ ì„±ê³µ (${responseTime}ms)`);
                } else {
                    throw new Error(data.error?.message || 'Unknown API error');
                }

                return data;
            } catch (error) {
                console.error('âŒ API ì˜¤ë¥˜:', error);
                
                // ë” ì •í™•í•œ ì—ëŸ¬ ë¶„ë¥˜
                if (error.name === 'TypeError' || error.message.includes('Failed to fetch')) {
                    showAlert('error', 'ğŸ”Œ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì˜¤ë¥˜: ì„œë²„ê°€ ì‘ë‹µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                } else if (error.message.includes('timeout')) {
                    showAlert('warning', 'â±ï¸ ìš”ì²­ ì‹œê°„ ì´ˆê³¼: ì„œë²„ê°€ ëŠë¦¬ê²Œ ì‘ë‹µí•©ë‹ˆë‹¤.');
                } else {
                    showAlert('error', `âŒ API ì˜¤ë¥˜: ${error.message}`);
                }
                
                displayError(error.message);
                throw error;
            } finally {
                showLoading(false);
            }
        }

        // ë‚˜ë¨¸ì§€ ê¸°ì¡´ í•¨ìˆ˜ë“¤...
        function showAlert(type, message) {
            console.log(`ğŸ“¢ Alert [${type}]:`, message);
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.style.position = 'fixed';
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '9999';
            alert.style.maxWidth = '400px';
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                ${message}
                <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; color: inherit; cursor: pointer;">Ã—</button>
            `;
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentElement) {
                    alert.remove();
                }
            }, 7000);
        }
    </script>
</body>
</html>
