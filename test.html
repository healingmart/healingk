<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>한국의 축제 - 실시간 축제 정보</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            color: #343a40;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .festival-card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100%;
        }
        .festival-card:hover {
            transform: translateY(-5px);
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }
        .status-ongoing {
            background-color: #d1fae5; /* green-100 */
            color: #065f46; /* green-800 */
        }
        .status-upcoming {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
        }
        .status-finished {
            background-color: #e0e7ff; /* indigo-100 */
            color: #3730a3; /* indigo-800 */
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #ffffff;
            margin: auto;
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 2rem;
            font-weight: bold;
            position: absolute;
            top: 1rem;
            right: 1.5rem;
        }
        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            background-color: #fee2e2; /* red-100 */
            color: #dc2626; /* red-600 */
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-weight: 500;
        }
        .no-results {
            background-color: #eff6ff; /* blue-50 */
            color: #2563eb; /* blue-700 */
            padding: 1.5rem;
            border-radius: 0.75rem;
            text-align: center;
            font-size: 1.125rem;
            font-weight: 500;
            margin-top: 2rem;
        }
        /* Custom scrollbar for modal content */
        .modal-content::-webkit-scrollbar {
            width: 8px;
            border-radius: 4px;
        }
        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <header class="bg-blue-600 text-white p-6 shadow-lg">
        <div class="container flex flex-col md:flex-row justify-between items-center">
            <h1 class="text-3xl font-bold mb-4 md:mb-0">한국의 축제 정보</h1>
            <nav class="text-lg">
                <a href="https://healingk.vercel.app" class="hover:underline">healingk.vercel.app</a>
            </nav>
        </div>
    </header>

    <main class="flex-grow container py-8">
        <section class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">축제 검색 및 필터링</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div>
                    <label for="keyword" class="block text-sm font-medium text-gray-700 mb-1">키워드 (축제명, 지역)</label>
                    <input type="text" id="keyword" placeholder="축제명 또는 지역 입력"
                           class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="areaCode" class="block text-sm font-medium text-gray-700 mb-1">지역</label>
                    <select id="areaCode" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="">전국</option>
                    </select>
                </div>
                <div>
                    <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">시작일</label>
                    <input type="date" id="startDate" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">종료일</label>
                    <input type="date" id="endDate" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>

            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="flex-grow grid grid-cols-1 sm:grid-cols-3 gap-3 w-full sm:w-auto">
                    <button id="searchButton" class="bg-blue-500 text-white px-5 py-2 rounded-md hover:bg-blue-600 transition-colors shadow-sm">
                        <span class="inline-block align-middle mr-2">🔍</span> 검색
                    </button>
                    <button id="resetButton" class="bg-gray-200 text-gray-800 px-5 py-2 rounded-md hover:bg-gray-300 transition-colors shadow-sm">
                        <span class="inline-block align-middle mr-2">🔄</span> 초기화
                    </button>
                    <button id="nearMeButton" class="bg-green-500 text-white px-5 py-2 rounded-md hover:bg-green-600 transition-colors shadow-sm">
                        <span class="inline-block align-middle mr-2">📍</span> 근처 축제 찾기
                    </button>
                </div>
                <div class="flex items-center gap-2 mt-4 sm:mt-0 w-full sm:w-auto">
                    <label for="statusFilter" class="text-sm font-medium text-gray-700">상태:</label>
                    <select id="statusFilter" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="all">전체</option>
                        <option value="ongoing">진행중</option>
                        <option value="upcoming">예정</option>
                        <option value="finished">종료</option>
                    </select>
                </div>
            </div>
        </section>

        <section class="bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">축제 목록</h2>
            <div id="loadingIndicator" class="flex justify-center items-center py-10 hidden">
                <div class="loading-spinner"></div>
                <p class="ml-4 text-lg text-gray-600">축제 정보를 불러오는 중...</p>
            </div>
            <div id="errorMessage" class="error-message hidden"></div>
            <div id="festivalList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Festival cards will be inserted here -->
            </div>
            <div id="noResults" class="no-results hidden">
                <p>현재 조건에 맞는 축제가 없습니다.</p>
                <p class="text-sm text-gray-500 mt-2">다른 검색 조건을 시도해 보세요.</p>
            </div>
            <div class="flex justify-center mt-8">
                <button id="loadMoreButton" class="bg-blue-100 text-blue-800 px-6 py-3 rounded-md hover:bg-blue-200 transition-colors shadow-sm font-semibold hidden">
                    더 많은 축제 불러오기
                </button>
            </div>
        </section>
    </main>

    <!-- 상세 정보 모달 -->
    <div id="detailModal" class="modal">
        <div class="modal-content relative">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <div id="modalContent">
                <!-- 상세 정보가 여기에 로드됩니다 -->
            </div>
        </div>
    </div>

    <footer class="bg-gray-800 text-white p-6 text-center shadow-inner mt-8">
        <div class="container">
            <p>&copy; 2025 한국의 축제 정보. All rights reserved.</p>
            <p class="mt-2 text-sm">Powered by Korea TourAPI 4.0</p>
        </div>
    </footer>

    <script>
        // API 키는 Vercel 환경 변수로 설정됩니다.
        // 클라이언트 코드에서는 직접 API 키를 삽입하지 않습니다.
        // `vercelHandler`가 `X-API-Key` 헤더를 통해 이를 검증할 것입니다.
        // 실제 API 호출은 `healingk.vercel.app` 백엔드 엔드포인트를 통해 이루어집니다.
        const API_ENDPOINT = 'https://healingk.vercel.app/api/tourism';
        const contentTypes = {
            12: '관광지',
            14: '문화시설',
            15: '축제공연행사',
            25: '여행코스',
            28: '레포츠',
            32: '숙박',
            38: '쇼핑',
            39: '음식점'
        };

        let currentPage = 1;
        const itemsPerPage = 9; // Grid layout makes 9 items per page visually appealing
        let totalCount = 0;
        let currentSearchQuery = {};
        let currentStatusFilter = 'all';

        const festivalListDiv = document.getElementById('festivalList');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessageDiv = document.getElementById('errorMessage');
        const noResultsDiv = document.getElementById('noResults');
        const loadMoreButton = document.getElementById('loadMoreButton');
        const areaCodeSelect = document.getElementById('areaCode');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const keywordInput = document.getElementById('keyword');
        const statusFilterSelect = document.getElementById('statusFilter');

        // ====== 유틸리티 함수 ======
        function showLoading() {
            loadingIndicator.classList.remove('hidden');
            festivalListDiv.classList.add('hidden');
            noResultsDiv.classList.add('hidden');
            errorMessageDiv.classList.add('hidden');
            loadMoreButton.classList.add('hidden');
        }

        function hideLoading() {
            loadingIndicator.classList.add('hidden');
            festivalListDiv.classList.remove('hidden');
        }

        function showErrorMessage(message) {
            errorMessageDiv.textContent = message;
            errorMessageDiv.classList.remove('hidden');
            hideLoading();
            noResultsDiv.classList.add('hidden');
            loadMoreButton.classList.add('hidden');
        }

        function hideErrorMessage() {
            errorMessageDiv.classList.add('hidden');
        }

        function showNoResults() {
            noResultsDiv.classList.remove('hidden');
            festivalListDiv.innerHTML = ''; // Clear existing list
            hideLoading();
            loadMoreButton.classList.add('hidden');
        }

        function hideNoResults() {
            noResultsDiv.classList.add('hidden');
        }

        function formatDate(dateString) {
            if (!dateString || dateString.length !== 8) return '날짜 미정';
            return `${dateString.substring(0, 4)}년 ${dateString.substring(4, 6)}월 ${dateString.substring(6, 8)}일`;
        }

        function getFestivalStatus(startDateStr, endDateStr) {
            const now = new Date();
            const start = new Date(startDateStr.substring(0, 4), parseInt(startDateStr.substring(4, 6)) - 1, startDateStr.substring(6, 8));
            const end = new Date(endDateStr.substring(0, 4), parseInt(endDateStr.substring(4, 6)) - 1, parseInt(endDateStr.substring(6, 8)) + 1); // 종료일 다음날 0시까지

            if (now < start) {
                return { text: '예정', class: 'status-upcoming' };
            } else if (now >= start && now < end) {
                return { text: '진행중', class: 'status-ongoing' };
            } else {
                return { text: '종료', class: 'status-finished' };
            }
        }

        // ====== API 호출 함수 ======
        async function fetchAPI(operation, params) {
            const urlParams = new URLSearchParams({ operation, ...params }).toString();
            try {
                const response = await fetch(`${API_ENDPOINT}?${urlParams}`);
                const data = await response.json();
                if (!response.ok || !data.success) {
                    throw new Error(data.error?.message || 'API 호출 실패');
                }
                return data.data;
            } catch (error) {
                console.error('API 호출 오류:', error);
                throw error;
            }
        }

        async function fetchAreaCodes() {
            try {
                const data = await fetchAPI('areaCode2', { numOfRows: 1000, pageNo: 1, MobileOS: 'WEB', MobileApp: 'HealingKApp' });
                if (data && data.items && data.items.item) {
                    const areas = Array.isArray(data.items.item) ? data.items.item : [data.items.item];
                    areas.forEach(area => {
                        const option = document.createElement('option');
                        option.value = area.code;
                        option.textContent = area.name;
                        areaCodeSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('지역 코드 불러오기 실패:', error);
                showErrorMessage('지역 정보를 불러오는데 실패했습니다.');
            }
        }

        async function fetchFestivals(isNewSearch = true) {
            showLoading();
            hideErrorMessage();
            hideNoResults();
            loadMoreButton.classList.add('hidden');

            if (isNewSearch) {
                currentPage = 1;
                festivalListDiv.innerHTML = ''; // Clear current list for new search
                currentSearchQuery = {
                    keyword: keywordInput.value,
                    areaCode: areaCodeSelect.value,
                    eventStartDate: startDateInput.value ? startDateInput.value.replace(/-/g, '') : '',
                    eventEndDate: endDateInput.value ? endDateInput.value.replace(/-/g, '') : '',
                };
            }

            const params = {
                contentTypeId: 15, // 축제공연행사
                numOfRows: itemsPerPage,
                pageNo: currentPage,
                MobileOS: 'WEB',
                MobileApp: 'HealingKApp',
                arrange: 'A', // 제목순
                ...currentSearchQuery
            };

            // Remove empty parameters
            for (const key in params) {
                if (params[key] === '' || params[key] === null || params[key] === undefined) {
                    delete params[key];
                }
            }

            // 날짜 범위가 유효한지 확인 (시작일이 종료일보다 늦으면 에러)
            if (params.eventStartDate && params.eventEndDate && params.eventStartDate > params.eventEndDate) {
                showErrorMessage('시작일은 종료일보다 늦을 수 없습니다.');
                hideLoading();
                return;
            }

            try {
                const data = await fetchAPI('searchFestival2', params);
                totalCount = data.totalCount || 0;
                const items = Array.isArray(data.items.item) ? data.items.item : (data.items.item ? [data.items.item] : []);

                if (items.length === 0 && isNewSearch) {
                    showNoResults();
                    return;
                } else if (items.length === 0 && !isNewSearch) {
                    // No more items to load
                    loadMoreButton.classList.add('hidden');
                    return;
                }

                // 필터링 적용 (클라이언트 측에서 진행 상태 필터링)
                const filteredItems = items.filter(item => {
                    if (currentStatusFilter === 'all') return true;
                    const status = getFestivalStatus(item.eventstartdate, item.eventenddate).text;
                    if (currentStatusFilter === 'ongoing' && status === '진행중') return true;
                    if (currentStatusFilter === 'upcoming' && status === '예정') return true;
                    if (currentStatusFilter === 'finished' && status === '종료') return true;
                    return false;
                });

                displayFestivals(filteredItems);

                if (currentPage * itemsPerPage < totalCount) {
                    loadMoreButton.classList.remove('hidden');
                } else {
                    loadMoreButton.classList.add('hidden');
                }

            } catch (error) {
                showErrorMessage(`축제 정보를 불러오는데 실패했습니다: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function fetchNearByFestivals() {
            if (!navigator.geolocation) {
                showErrorMessage('이 브라우저는 Geolocation을 지원하지 않습니다.');
                return;
            }

            showLoading();
            hideErrorMessage();
            hideNoResults();
            loadMoreButton.classList.add('hidden');
            festivalListDiv.innerHTML = '';

            navigator.geolocation.getCurrentPosition(async (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const radius = 20000; // 20km 반경

                currentPage = 1; // Reset page for nearby search

                const params = {
                    contentTypeId: 15, // 축제공연행사
                    numOfRows: itemsPerPage,
                    pageNo: currentPage,
                    MobileOS: 'WEB',
                    MobileApp: 'HealingKApp',
                    mapX: lng,
                    mapY: lat,
                    radius: radius,
                    arrange: 'S', // 거리순 정렬
                    addDistance: 'Y' // 백엔드에서 거리 정보 추가하도록 요청
                };

                try {
                    const data = await fetchAPI('locationBasedList2', params);
                    totalCount = data.totalCount || 0;
                    const items = Array.isArray(data.items.item) ? data.items.item : (data.items.item ? [data.items.item] : []);

                    if (items.length === 0) {
                        showNoResults();
                        return;
                    }

                    // 필터링 적용 (클라이언트 측에서 진행 상태 필터링)
                    const filteredItems = items.filter(item => {
                        if (currentStatusFilter === 'all') return true;
                        const status = getFestivalStatus(item.eventstartdate, item.eventenddate).text; // locationBasedList는 eventstartdate/enddate를 직접 주지 않으므로 가정
                        if (currentStatusFilter === 'ongoing' && status === '진행중') return true;
                        if (currentStatusFilter === 'upcoming' && status === '예정') return true;
                        if (currentStatusFilter === 'finished' && status === '종료') return true;
                        return false;
                    });

                    displayFestivals(filteredItems);

                    if (currentPage * itemsPerPage < totalCount) {
                        loadMoreButton.classList.remove('hidden');
                    } else {
                        loadMoreButton.classList.add('hidden');
                    }

                } catch (error) {
                    showErrorMessage(`근처 축제를 불러오는데 실패했습니다: ${error.message}`);
                } finally {
                    hideLoading();
                }
            }, (error) => {
                console.error('Geolocation 오류:', error);
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        showErrorMessage('위치 정보 접근이 거부되었습니다. 근처 축제를 찾으려면 위치 권한을 허용해주세요.');
                        break;
                    case error.POSITION_UNAVAILABLE:
                        showErrorMessage('위치 정보를 사용할 수 없습니다.');
                        break;
                    case error.TIMEOUT:
                        showErrorMessage('위치 정보를 가져오는 시간이 초과되었습니다.');
                        break;
                    default:
                        showErrorMessage(`Geolocation 오류: ${error.message}`);
                }
                hideLoading();
            });
        }


        // ====== UI 렌더링 함수 ======
        function displayFestivals(festivals) {
            if (!festivals || festivals.length === 0) {
                if (currentPage === 1) { // Only show no results if it's the first page
                    showNoResults();
                } else { // If loading more and no new results, just hide load more button
                    loadMoreButton.classList.add('hidden');
                }
                return;
            }

            hideNoResults();

            festivals.forEach(festival => {
                const status = getFestivalStatus(festival.eventstartdate, festival.eventenddate);
                const card = document.createElement('div');
                card.className = 'festival-card cursor-pointer';
                card.innerHTML = `
                    <div class="relative w-full h-48 bg-gray-200 overflow-hidden">
                        <img src="${festival.firstimage || 'https://placehold.co/500x300/e0e0e0/555555?text=No+Image'}"
                             alt="${festival.title || '축제 이미지'}"
                             class="w-full h-full object-cover"
                             onerror="this.onerror=null;this.src='https://placehold.co/500x300/e0e0e0/555555?text=No+Image';" />
                        <span class="absolute top-3 left-3 status-badge ${status.class}">${status.text}</span>
                    </div>
                    <div class="p-5 flex-grow flex flex-col">
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">${festival.title || '제목 없음'}</h3>
                        <p class="text-sm text-gray-600 mb-1">
                            <strong>기간:</strong> ${formatDate(festival.eventstartdate)} ~ ${formatDate(festival.eventenddate)}
                        </p>
                        <p class="text-sm text-gray-600 mb-3">
                            <strong>장소:</strong> ${festival.addr1 || '장소 미정'}
                        </p>
                        ${festival.distance ? `<p class="text-sm text-gray-700 font-medium mt-auto"><strong>거리:</strong> 약 ${festival.distance}m</p>` : ''}
                    </div>
                `;
                card.onclick = () => openDetailModal(festival.contentid, festival.contentTypeId);
                festivalListDiv.appendChild(card);
            });
        }

        async function openDetailModal(contentId, contentTypeId) {
            const modal = document.getElementById('detailModal');
            const modalContentDiv = document.getElementById('modalContent');
            modalContentDiv.innerHTML = '<div class="flex justify-center items-center h-48"><div class="loading-spinner"></div></div>';
            modal.style.display = 'flex';

            try {
                // 공통 정보 조회
                const commonData = await fetchAPI('detailCommon2', {
                    contentId: contentId,
                    MobileOS: 'WEB',
                    MobileApp: 'HealingKApp'
                });
                const commonItem = commonData.items.item[0];

                // 소개 정보 조회
                const introData = await fetchAPI('detailIntro2', {
                    contentId: contentId,
                    contentTypeId: contentTypeId,
                    MobileOS: 'WEB',
                    MobileApp: 'HealingKApp'
                });
                const introItem = introData.items.item[0];

                // 이미지 정보 조회
                const imageData = await fetchAPI('detailImage2', {
                    contentId: contentId,
                    imageYN: 'Y',
                    MobileOS: 'WEB',
                    MobileApp: 'HealingKApp'
                });
                const images = Array.isArray(imageData.items.item) ? imageData.items.item : (imageData.items.item ? [imageData.items.item] : []);

                let homepageLink = commonItem.homepage ? commonItem.homepage.replace(/<[^>]*>/g, '') : '정보 없음'; // HTML 태그 제거
                if (homepageLink && !homepageLink.startsWith('http')) {
                    homepageLink = `http://${homepageLink}`; // 링크가 http:// 또는 https://로 시작하지 않는 경우 보정
                }

                modalContentDiv.innerHTML = `
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">${commonItem.title || '제목 없음'}</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="flex flex-col">
                            ${images.length > 0 ? `
                                <img src="${images[0].originimgurl || 'https://placehold.co/800x600/e0e0e0/555555?text=No+Image'}"
                                     alt="${commonItem.title || '축제 이미지'}"
                                     class="w-full h-auto rounded-lg shadow-md mb-4"
                                     onerror="this.onerror=null;this.src='https://placehold.co/800x600/e0e0e0/555555?text=No+Image';" />
                            ` : `
                                <img src="https://placehold.co/800x600/e0e0e0/555555?text=No+Image"
                                     alt="이미지 없음"
                                     class="w-full h-auto rounded-lg shadow-md mb-4" />
                            `}
                            ${images.length > 1 ? `
                                <div class="grid grid-cols-3 gap-2 overflow-x-auto">
                                    ${images.slice(1).map(img => `
                                        <img src="${img.smallimageurl || 'https://placehold.co/150x100/e0e0e0/555555?text=No+Image'}"
                                             alt="${img.imgname || '축제 서브 이미지'}"
                                             class="w-full h-20 object-cover rounded-md cursor-pointer hover:opacity-80 transition-opacity"
                                             onclick="this.closest('.modal-content').querySelector('img').src = '${img.originimgurl || 'https://placehold.co/800x600/e0e0e0/555555?text=No+Image'}';"
                                             onerror="this.onerror=null;this.src='https://placehold.co/150x100/e0e0e0/555555?text=No+Image';" />
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                        <div>
                            <p class="text-lg text-gray-700 mb-2"><strong>장소:</strong> ${commonItem.addr1 || '정보 없음'} ${commonItem.addr2 || ''}</p>
                            <p class="text-lg text-gray-700 mb-2"><strong>전화:</strong> ${commonItem.tel || '정보 없음'}</p>
                            <p class="text-lg text-gray-700 mb-2"><strong>홈페이지:</strong>
                                ${homepageLink !== '정보 없음' ? `<a href="${homepageLink}" target="_blank" class="text-blue-600 hover:underline">${homepageLink}</a>` : '정보 없음'}
                            </p>
                            <p class="text-lg text-gray-700 mb-2"><strong>개장일:</strong> ${introItem.opendate || '정보 없음'}</p>
                            <p class="text-lg text-gray-700 mb-2"><strong>쉬는날:</strong> ${introItem.restdate || '정보 없음'}</p>
                            <p class="text-lg text-gray-700 mb-2"><strong>이용시간:</strong> ${introItem.usetime || '정보 없음'}</p>
                            <p class="text-lg text-gray-700 mb-2"><strong>주차시설:</strong> ${introItem.parking || '정보 없음'}</p>
                            ${introItem.usetimefestival ? `<p class="text-lg text-gray-700 mb-2"><strong>이용요금:</strong> ${introItem.usetimefestival}</p>` : ''}
                            ${introItem.eventplace ? `<p class="text-lg text-gray-700 mb-2"><strong>행사장소:</strong> ${introItem.eventplace}</p>` : ''}
                            ${introItem.program ? `<p class="text-lg text-gray-700 mb-2"><strong>프로그램:</strong> ${introItem.program}</p>` : ''}

                            <h3 class="text-xl font-semibold text-gray-800 mt-6 mb-2">개요</h3>
                            <div class="text-base text-gray-700 leading-relaxed overflow-y-auto max-h-60 rounded-md p-3 bg-gray-50 border border-gray-200">
                                ${commonItem.overview ? commonItem.overview.replace(/<br\s*\/?>/gi, '\n').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&').replace(/&quot;/g, '"').replace(/&#39;/g, "'") : '상세 개요 정보가 없습니다.'}
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                modalContentDiv.innerHTML = `<div class="error-message">상세 정보를 불러오는데 실패했습니다: ${error.message}</div>`;
                console.error('상세 정보 불러오기 오류:', error);
            }
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
            document.getElementById('modalContent').innerHTML = ''; // Clear content on close
        }

        // ====== 이벤트 리스너 ======
        document.getElementById('searchButton').addEventListener('click', () => fetchFestivals(true));
        document.getElementById('resetButton').addEventListener('click', () => {
            keywordInput.value = '';
            areaCodeSelect.value = '';
            startDateInput.value = ''; 
            endDateInput.value = '';
            statusFilterSelect.value = 'all';
            fetchFestivals(true); // Reset and fetch
        });
        document.getElementById('nearMeButton').addEventListener('click', fetchNearByFestivals);
        loadMoreButton.addEventListener('click', () => {
            currentPage++;
            fetchFestivals(false);
        });
        statusFilterSelect.addEventListener('change', () => {
            currentStatusFilter = statusFilterSelect.value;
            // Re-fetch with current filters, but re-render from page 1
            // A more efficient way would be to re-filter the already loaded items if the filter is client-side.
            // For simplicity and given the API structure, we'll re-fetch.
            fetchFestivals(true);
        });

        // 모달 외부 클릭 시 닫기
        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target == modal) {
                closeModal();
            }
        }
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && document.getElementById('detailModal').style.display === 'flex') {
                closeModal();
            }
        });

        // 초기 로딩
        document.addEventListener('DOMContentLoaded', () => {
            fetchAreaCodes();
            fetchFestivals(true);
        });
    </script>
</body>
</html>
