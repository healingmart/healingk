<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 AllTourism Enterprise Test Dashboard v2.0</title>
    <style>
        /* 기존 스타일 유지 */
        :root {
            --primary-color: #2563eb;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
        }
        
        .diagnostic-panel {
            background: linear-gradient(135deg, #fee2e2, #fef3c7);
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .version-check {
            background: #1f2937;
            color: white;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            margin: 1rem 0;
        }
        
        .api-endpoint-display {
            background: rgba(37, 99, 235, 0.1);
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            border-left: 4px solid var(--primary-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 🚨 긴급 진단 패널 -->
        <div class="diagnostic-panel">
            <h2>🔧 버전 진단 패널</h2>
            <div class="alert alert-warning">
                <strong>⚠️ 중요:</strong> 로그에서 구버전 API (KorService1) 호출이 감지되었습니다!
            </div>
            
            <div class="version-check">
                <h4>현재 배포된 버전 확인:</h4>
                <div id="versionInfo">확인 중...</div>
            </div>
            
            <div class="api-endpoint-display">
                <h4>올바른 API 엔드포인트:</h4>
                <code>https://apis.data.go.kr/B551011/KorService2/areaBasedList2</code>
            </div>
            
            <button class="btn btn-danger" onclick="diagnoseVersion()">
                🔍 긴급 버전 진단
            </button>
            <button class="btn btn-warning" onclick="forceRefresh()">
                🔄 강제 새로고침
            </button>
        </div>

        <!-- 기존 헤더 수정 -->
        <header class="header">
            <h1>🚀 AllTourism Enterprise Test Dashboard v2.0</h1>
            <p>한국관광공사 TourAPI 4.0 Enterprise - 버전 확인 및 진단</p>
            <div class="header-controls">
                <input type="url" class="api-url-input" id="apiUrl" 
                       placeholder="API 서버 URL 입력" 
                       value="">
                <button class="btn btn-secondary" onclick="setApiUrl()">
                    🔗 URL 설정
                </button>
            </div>
        </header>

        <!-- 나머지 기존 코드... -->
    </div>

    <script>
        // 🔧 개선된 JavaScript
        let API_BASE_URL = '';

        // 초기화 시 API URL 감지
        document.addEventListener('DOMContentLoaded', function() {
            detectApiUrl();
            diagnoseVersion();
        });

        // API URL 자동 감지
        function detectApiUrl() {
            const possibleUrls = [
                'https://healingk.vercel.app',
                window.location.origin,
                'http://localhost:3000',
                'http://localhost:8080'
            ];

            // 첫 번째로 응답하는 URL 사용
            Promise.race(
                possibleUrls.map(url => 
                    fetch(`${url}/api/health`)
                        .then(res => res.ok ? url : Promise.reject())
                        .catch(() => Promise.reject())
                )
            ).then(workingUrl => {
                API_BASE_URL = workingUrl;
                document.getElementById('apiUrl').value = workingUrl;
                showAlert('success', `✅ API 서버 발견: ${workingUrl}`);
            }).catch(() => {
                showAlert('error', '❌ 사용 가능한 API 서버를 찾을 수 없습니다.');
            });
        }

        // 🔍 버전 진단 함수
        async function diagnoseVersion() {
            try {
                showAlert('info', '🔍 시스템 버전을 확인 중...');
                
                const response = await fetch(`${API_BASE_URL}/api/health`);
                const data = await response.json();
                
                const versionInfo = document.getElementById('versionInfo');
                versionInfo.innerHTML = `
                    <div>✅ 서버 응답: ${response.status}</div>
                    <div>📦 버전: ${data.version || 'Unknown'}</div>
                    <div>🏗️ 환경: ${data.config?.environment || 'Unknown'}</div>
                    <div>🔑 API 키: ${data.config?.apiKeyConfigured ? 'YES' : 'NO'}</div>
                    <div>🏛️ 컨테이너: ${data.config ? 'Initialized' : 'Error'}</div>
                `;

                // 실제 API 테스트
                await testActualApi();
                
            } catch (error) {
                document.getElementById('versionInfo').innerHTML = `
                    <div style="color: var(--error-color);">❌ 버전 확인 실패: ${error.message}</div>
                `;
            }
        }

        // 🧪 실제 API 엔드포인트 테스트
        async function testActualApi() {
            try {
                const testParams = {
                    operation: 'areaBasedList',
                    areaCode: '1',
                    numOfRows: '1'
                };

                const response = await fetch(`${API_BASE_URL}/api/tour?` + new URLSearchParams(testParams));
                const data = await response.json();
                
                if (data.success) {
                    showAlert('success', '🎉 새로운 API (KorService2) 확인됨!');
                } else {
                    showAlert('error', `❌ API 테스트 실패: ${data.error?.message}`);
                }
                
                // 결과에 API 엔드포인트 정보 표시
                displayApiDiagnostic(data);
                
            } catch (error) {
                showAlert('error', `🚨 API 테스트 중 오류: ${error.message}`);
            }
        }

        function displayApiDiagnostic(data) {
            const diagnostic = `
                <div class="result-item" style="border-left-color: var(--info-color);">
                    <h4>🔍 API 엔드포인트 진단 결과</h4>
                    <div class="json-viewer">
{
  "diagnosis": {
    "expectedEndpoint": "https://apis.data.go.kr/B551011/KorService2/areaBasedList2",
    "apiResponse": ${data.success ? '"SUCCESS"' : '"FAILED"'},
    "timestamp": "${new Date().toISOString()}",
    "version": "${data.metadata?.version || 'Unknown'}",
    "serverType": "${data.success ? 'AllTourism Enterprise v2.0' : 'Legacy or Error'}"
  },
  "serverResponse": ${JSON.stringify(data, null, 2)}
}
                    </div>
                </div>
            `;
            
            document.getElementById('resultsContent').innerHTML = diagnostic + document.getElementById('resultsContent').innerHTML;
        }

        function setApiUrl() {
            const newUrl = document.getElementById('apiUrl').value;
            if (newUrl) {
                API_BASE_URL = newUrl;
                showAlert('info', `🔗 API URL 변경: ${newUrl}`);
                diagnoseVersion();
            }
        }

        function forceRefresh() {
            // 캐시 무시하고 페이지 새로고침
            window.location.reload(true);
        }

        // 🔧 개선된 에러 처리
        async function callAPI(endpoint, params = {}, method = 'GET') {
            if (!API_BASE_URL) {
                throw new Error('API 서버 URL이 설정되지 않았습니다.');
            }

            const startTime = Date.now();
            
            try {
                showLoading(true);
                
                let url = `${API_BASE_URL}${endpoint}`;
                let options = {
                    method: method,
                    headers: {
                        'Accept': 'application/json',
                        'Accept-Language': currentLanguage,
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'  // 캐시 방지
                    }
                };

                // GET 요청 처리
                if (method === 'GET') {
                    const urlObj = new URL(url);
                    Object.entries(params).forEach(([key, value]) => {
                        if (value !== null && value !== '' && value !== undefined) {
                            urlObj.searchParams.append(key, value);
                        }
                    });
                    url = urlObj.toString();
                } else {
                    options.body = JSON.stringify(params);
                }

                console.log('🚀 API 호출:', { url, method, params });

                const response = await fetch(url, options);
                const data = await response.json();
                const responseTime = Date.now() - startTime;
                
                // 상세 로깅
                console.log('📡 API 응답:', { status: response.status, data, responseTime });

                if (data.success) {
                    displayResults(data, responseTime);
                    showAlert('success', `✅ API 호출 성공 (${responseTime}ms)`);
                } else {
                    throw new Error(data.error?.message || 'Unknown API error');
                }

                return data;
            } catch (error) {
                console.error('❌ API 오류:', error);
                
                // 더 정확한 에러 분류
                if (error.name === 'TypeError' || error.message.includes('Failed to fetch')) {
                    showAlert('error', '🔌 네트워크 연결 오류: 서버가 응답하지 않습니다.');
                } else if (error.message.includes('timeout')) {
                    showAlert('warning', '⏱️ 요청 시간 초과: 서버가 느리게 응답합니다.');
                } else {
                    showAlert('error', `❌ API 오류: ${error.message}`);
                }
                
                displayError(error.message);
                throw error;
            } finally {
                showLoading(false);
            }
        }

        // 나머지 기존 함수들...
        function showAlert(type, message) {
            console.log(`📢 Alert [${type}]:`, message);
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.style.position = 'fixed';
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '9999';
            alert.style.maxWidth = '400px';
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                ${message}
                <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; color: inherit; cursor: pointer;">×</button>
            `;
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentElement) {
                    alert.remove();
                }
            }, 7000);
        }
    </script>
</body>
</html>
