<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­ì˜ ì¶•ì œ - ì‹¤ì‹œê°„ ì¶•ì œ ì •ë³´</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            color: #343a40;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .festival-card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100%;
        }
        .festival-card:hover {
            transform: translateY(-5px);
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }
        .status-ongoing {
            background-color: #d1fae5; /* green-100 */
            color: #065f46; /* green-800 */
        }
        .status-upcoming {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
        }
        .status-finished {
            background-color: #e0e7ff; /* indigo-100 */
            color: #3730a3; /* indigo-800 */
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #ffffff;
            margin: auto;
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 2rem;
            font-weight: bold;
            position: absolute;
            top: 1rem;
            right: 1.5rem;
        }
        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            background-color: #fee2e2; /* red-100 */
            color: #dc2626; /* red-600 */
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-weight: 500;
        }
        .no-results {
            background-color: #eff6ff; /* blue-50 */
            color: #2563eb; /* blue-700 */
            padding: 1.5rem;
            border-radius: 0.75rem;
            text-align: center;
            font-size: 1.125rem;
            font-weight: 500;
            margin-top: 2rem;
        }
        /* Custom scrollbar for modal content */
        .modal-content::-webkit-scrollbar {
            width: 8px;
            border-radius: 4px;
        }
        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <header class="bg-blue-600 text-white p-6 shadow-lg">
        <div class="container flex flex-col md:flex-row justify-between items-center">
            <h1 class="text-3xl font-bold mb-4 md:mb-0">í•œêµ­ì˜ ì¶•ì œ ì •ë³´</h1>
            <nav class="text-lg">
                <a href="https://healingk.vercel.app" class="hover:underline">healingk.vercel.app</a>
            </nav>
        </div>
    </header>

    <main class="flex-grow container py-8">
        <section class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">ì¶•ì œ ê²€ìƒ‰ ë° í•„í„°ë§</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div>
                    <label for="keyword" class="block text-sm font-medium text-gray-700 mb-1">í‚¤ì›Œë“œ (ì¶•ì œëª…, ì§€ì—­)</label>
                    <input type="text" id="keyword" placeholder="ì¶•ì œëª… ë˜ëŠ” ì§€ì—­ ì…ë ¥"
                           class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="areaCode" class="block text-sm font-medium text-gray-700 mb-1">ì§€ì—­</label>
                    <select id="areaCode" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="">ì „êµ­</option>
                    </select>
                </div>
                <div>
                    <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">ì‹œì‘ì¼</label>
                    <input type="date" id="startDate" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">ì¢…ë£Œì¼</label>
                    <input type="date" id="endDate" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>

            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="flex-grow grid grid-cols-1 sm:grid-cols-3 gap-3 w-full sm:w-auto">
                    <button id="searchButton" class="bg-blue-500 text-white px-5 py-2 rounded-md hover:bg-blue-600 transition-colors shadow-sm">
                        <span class="inline-block align-middle mr-2">ğŸ”</span> ê²€ìƒ‰
                    </button>
                    <button id="resetButton" class="bg-gray-200 text-gray-800 px-5 py-2 rounded-md hover:bg-gray-300 transition-colors shadow-sm">
                        <span class="inline-block align-middle mr-2">ğŸ”„</span> ì´ˆê¸°í™”
                    </button>
                    <button id="nearMeButton" class="bg-green-500 text-white px-5 py-2 rounded-md hover:bg-green-600 transition-colors shadow-sm">
                        <span class="inline-block align-middle mr-2">ğŸ“</span> ê·¼ì²˜ ì¶•ì œ ì°¾ê¸°
                    </button>
                </div>
                <div class="flex items-center gap-2 mt-4 sm:mt-0 w-full sm:w-auto">
                    <label for="statusFilter" class="text-sm font-medium text-gray-700">ìƒíƒœ:</label>
                    <select id="statusFilter" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="all">ì „ì²´</option>
                        <option value="ongoing">ì§„í–‰ì¤‘</option>
                        <option value="upcoming">ì˜ˆì •</option>
                        <option value="finished">ì¢…ë£Œ</option>
                    </select>
                </div>
            </div>
        </section>

        <section class="bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">ì¶•ì œ ëª©ë¡</h2>
            <div id="loadingIndicator" class="flex justify-center items-center py-10 hidden">
                <div class="loading-spinner"></div>
                <p class="ml-4 text-lg text-gray-600">ì¶•ì œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
            <div id="errorMessage" class="error-message hidden"></div>
            <div id="festivalList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Festival cards will be inserted here -->
            </div>
            <div id="noResults" class="no-results hidden">
                <p>í˜„ì¬ ì¡°ê±´ì— ë§ëŠ” ì¶•ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                <p class="text-sm text-gray-500 mt-2">ë‹¤ë¥¸ ê²€ìƒ‰ ì¡°ê±´ì„ ì‹œë„í•´ ë³´ì„¸ìš”.</p>
            </div>
            <div class="flex justify-center mt-8">
                <button id="loadMoreButton" class="bg-blue-100 text-blue-800 px-6 py-3 rounded-md hover:bg-blue-200 transition-colors shadow-sm font-semibold hidden">
                    ë” ë§ì€ ì¶•ì œ ë¶ˆëŸ¬ì˜¤ê¸°
                </button>
            </div>
        </section>
    </main>

    <!-- ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
    <div id="detailModal" class="modal">
        <div class="modal-content relative">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <div id="modalContent">
                <!-- ìƒì„¸ ì •ë³´ê°€ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>

    <footer class="bg-gray-800 text-white p-6 text-center shadow-inner mt-8">
        <div class="container">
            <p>&copy; 2025 í•œêµ­ì˜ ì¶•ì œ ì •ë³´. All rights reserved.</p>
            <p class="mt-2 text-sm">Powered by Korea TourAPI 4.0</p>
        </div>
    </footer>

    <script>
        // API í‚¤ëŠ” Vercel í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •ë©ë‹ˆë‹¤.
        // í´ë¼ì´ì–¸íŠ¸ ì½”ë“œì—ì„œëŠ” ì§ì ‘ API í‚¤ë¥¼ ì‚½ì…í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        // `vercelHandler`ê°€ `X-API-Key` í—¤ë”ë¥¼ í†µí•´ ì´ë¥¼ ê²€ì¦í•  ê²ƒì…ë‹ˆë‹¤.
        // ì‹¤ì œ API í˜¸ì¶œì€ `healingk.vercel.app` ë°±ì—”ë“œ ì—”ë“œí¬ì¸íŠ¸ë¥¼ í†µí•´ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.
        const API_ENDPOINT = 'https://healingk.vercel.app/api/tourism';
        const contentTypes = {
            12: 'ê´€ê´‘ì§€',
            14: 'ë¬¸í™”ì‹œì„¤',
            15: 'ì¶•ì œê³µì—°í–‰ì‚¬',
            25: 'ì—¬í–‰ì½”ìŠ¤',
            28: 'ë ˆí¬ì¸ ',
            32: 'ìˆ™ë°•',
            38: 'ì‡¼í•‘',
            39: 'ìŒì‹ì '
        };

        let currentPage = 1;
        const itemsPerPage = 9; // Grid layout makes 9 items per page visually appealing
        let totalCount = 0;
        let currentSearchQuery = {};
        let currentStatusFilter = 'all';

        const festivalListDiv = document.getElementById('festivalList');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessageDiv = document.getElementById('errorMessage');
        const noResultsDiv = document.getElementById('noResults');
        const loadMoreButton = document.getElementById('loadMoreButton');
        const areaCodeSelect = document.getElementById('areaCode');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const keywordInput = document.getElementById('keyword');
        const statusFilterSelect = document.getElementById('statusFilter');

        // ====== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ======
        function showLoading() {
            loadingIndicator.classList.remove('hidden');
            festivalListDiv.classList.add('hidden');
            noResultsDiv.classList.add('hidden');
            errorMessageDiv.classList.add('hidden');
            loadMoreButton.classList.add('hidden');
        }

        function hideLoading() {
            loadingIndicator.classList.add('hidden');
            festivalListDiv.classList.remove('hidden');
        }

        function showErrorMessage(message) {
            errorMessageDiv.textContent = message;
            errorMessageDiv.classList.remove('hidden');
            hideLoading();
            noResultsDiv.classList.add('hidden');
            loadMoreButton.classList.add('hidden');
        }

        function hideErrorMessage() {
            errorMessageDiv.classList.add('hidden');
        }

        function showNoResults() {
            noResultsDiv.classList.remove('hidden');
            festivalListDiv.innerHTML = ''; // Clear existing list
            hideLoading();
            loadMoreButton.classList.add('hidden');
        }

        function hideNoResults() {
            noResultsDiv.classList.add('hidden');
        }

        function formatDate(dateString) {
            if (!dateString || dateString.length !== 8) return 'ë‚ ì§œ ë¯¸ì •';
            return `${dateString.substring(0, 4)}ë…„ ${dateString.substring(4, 6)}ì›” ${dateString.substring(6, 8)}ì¼`;
        }

        function getFestivalStatus(startDateStr, endDateStr) {
            const now = new Date();
            const start = new Date(startDateStr.substring(0, 4), parseInt(startDateStr.substring(4, 6)) - 1, startDateStr.substring(6, 8));
            const end = new Date(endDateStr.substring(0, 4), parseInt(endDateStr.substring(4, 6)) - 1, parseInt(endDateStr.substring(6, 8)) + 1); // ì¢…ë£Œì¼ ë‹¤ìŒë‚  0ì‹œê¹Œì§€

            if (now < start) {
                return { text: 'ì˜ˆì •', class: 'status-upcoming' };
            } else if (now >= start && now < end) {
                return { text: 'ì§„í–‰ì¤‘', class: 'status-ongoing' };
            } else {
                return { text: 'ì¢…ë£Œ', class: 'status-finished' };
            }
        }

        // ====== API í˜¸ì¶œ í•¨ìˆ˜ ======
        async function fetchAPI(operation, params) {
            const urlParams = new URLSearchParams({ operation, ...params }).toString();
            try {
                const response = await fetch(`${API_ENDPOINT}?${urlParams}`);
                const data = await response.json();
                if (!response.ok || !data.success) {
                    throw new Error(data.error?.message || 'API í˜¸ì¶œ ì‹¤íŒ¨');
                }
                return data.data;
            } catch (error) {
                console.error('API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                throw error;
            }
        }

        async function fetchAreaCodes() {
            try {
                const data = await fetchAPI('areaCode2', { numOfRows: 1000, pageNo: 1, MobileOS: 'WEB', MobileApp: 'HealingKApp' });
                if (data && data.items && data.items.item) {
                    const areas = Array.isArray(data.items.item) ? data.items.item : [data.items.item];
                    areas.forEach(area => {
                        const option = document.createElement('option');
                        option.value = area.code;
                        option.textContent = area.name;
                        areaCodeSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('ì§€ì—­ ì½”ë“œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
                showErrorMessage('ì§€ì—­ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function fetchFestivals(isNewSearch = true) {
            showLoading();
            hideErrorMessage();
            hideNoResults();
            loadMoreButton.classList.add('hidden');

            if (isNewSearch) {
                currentPage = 1;
                festivalListDiv.innerHTML = ''; // Clear current list for new search
                currentSearchQuery = {
                    keyword: keywordInput.value,
                    areaCode: areaCodeSelect.value,
                    eventStartDate: startDateInput.value ? startDateInput.value.replace(/-/g, '') : '',
                    eventEndDate: endDateInput.value ? endDateInput.value.replace(/-/g, '') : '',
                };
            }

            const params = {
                contentTypeId: 15, // ì¶•ì œê³µì—°í–‰ì‚¬
                numOfRows: itemsPerPage,
                pageNo: currentPage,
                MobileOS: 'WEB',
                MobileApp: 'HealingKApp',
                arrange: 'A', // ì œëª©ìˆœ
                ...currentSearchQuery
            };

            // Remove empty parameters
            for (const key in params) {
                if (params[key] === '' || params[key] === null || params[key] === undefined) {
                    delete params[key];
                }
            }

            // ë‚ ì§œ ë²”ìœ„ê°€ ìœ íš¨í•œì§€ í™•ì¸ (ì‹œì‘ì¼ì´ ì¢…ë£Œì¼ë³´ë‹¤ ëŠ¦ìœ¼ë©´ ì—ëŸ¬)
            if (params.eventStartDate && params.eventEndDate && params.eventStartDate > params.eventEndDate) {
                showErrorMessage('ì‹œì‘ì¼ì€ ì¢…ë£Œì¼ë³´ë‹¤ ëŠ¦ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                hideLoading();
                return;
            }

            try {
                const data = await fetchAPI('searchFestival2', params);
                totalCount = data.totalCount || 0;
                const items = Array.isArray(data.items.item) ? data.items.item : (data.items.item ? [data.items.item] : []);

                if (items.length === 0 && isNewSearch) {
                    showNoResults();
                    return;
                } else if (items.length === 0 && !isNewSearch) {
                    // No more items to load
                    loadMoreButton.classList.add('hidden');
                    return;
                }

                // í•„í„°ë§ ì ìš© (í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ì§„í–‰ ìƒíƒœ í•„í„°ë§)
                const filteredItems = items.filter(item => {
                    if (currentStatusFilter === 'all') return true;
                    const status = getFestivalStatus(item.eventstartdate, item.eventenddate).text;
                    if (currentStatusFilter === 'ongoing' && status === 'ì§„í–‰ì¤‘') return true;
                    if (currentStatusFilter === 'upcoming' && status === 'ì˜ˆì •') return true;
                    if (currentStatusFilter === 'finished' && status === 'ì¢…ë£Œ') return true;
                    return false;
                });

                displayFestivals(filteredItems);

                if (currentPage * itemsPerPage < totalCount) {
                    loadMoreButton.classList.remove('hidden');
                } else {
                    loadMoreButton.classList.add('hidden');
                }

            } catch (error) {
                showErrorMessage(`ì¶•ì œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function fetchNearByFestivals() {
            if (!navigator.geolocation) {
                showErrorMessage('ì´ ë¸Œë¼ìš°ì €ëŠ” Geolocationì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            showLoading();
            hideErrorMessage();
            hideNoResults();
            loadMoreButton.classList.add('hidden');
            festivalListDiv.innerHTML = '';

            navigator.geolocation.getCurrentPosition(async (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const radius = 20000; // 20km ë°˜ê²½

                currentPage = 1; // Reset page for nearby search

                const params = {
                    contentTypeId: 15, // ì¶•ì œê³µì—°í–‰ì‚¬
                    numOfRows: itemsPerPage,
                    pageNo: currentPage,
                    MobileOS: 'WEB',
                    MobileApp: 'HealingKApp',
                    mapX: lng,
                    mapY: lat,
                    radius: radius,
                    arrange: 'S', // ê±°ë¦¬ìˆœ ì •ë ¬
                    addDistance: 'Y' // ë°±ì—”ë“œì—ì„œ ê±°ë¦¬ ì •ë³´ ì¶”ê°€í•˜ë„ë¡ ìš”ì²­
                };

                try {
                    const data = await fetchAPI('locationBasedList2', params);
                    totalCount = data.totalCount || 0;
                    const items = Array.isArray(data.items.item) ? data.items.item : (data.items.item ? [data.items.item] : []);

                    if (items.length === 0) {
                        showNoResults();
                        return;
                    }

                    // í•„í„°ë§ ì ìš© (í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ì§„í–‰ ìƒíƒœ í•„í„°ë§)
                    const filteredItems = items.filter(item => {
                        if (currentStatusFilter === 'all') return true;
                        const status = getFestivalStatus(item.eventstartdate, item.eventenddate).text; // locationBasedListëŠ” eventstartdate/enddateë¥¼ ì§ì ‘ ì£¼ì§€ ì•Šìœ¼ë¯€ë¡œ ê°€ì •
                        if (currentStatusFilter === 'ongoing' && status === 'ì§„í–‰ì¤‘') return true;
                        if (currentStatusFilter === 'upcoming' && status === 'ì˜ˆì •') return true;
                        if (currentStatusFilter === 'finished' && status === 'ì¢…ë£Œ') return true;
                        return false;
                    });

                    displayFestivals(filteredItems);

                    if (currentPage * itemsPerPage < totalCount) {
                        loadMoreButton.classList.remove('hidden');
                    } else {
                        loadMoreButton.classList.add('hidden');
                    }

                } catch (error) {
                    showErrorMessage(`ê·¼ì²˜ ì¶•ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                } finally {
                    hideLoading();
                }
            }, (error) => {
                console.error('Geolocation ì˜¤ë¥˜:', error);
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        showErrorMessage('ìœ„ì¹˜ ì •ë³´ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ê·¼ì²˜ ì¶•ì œë¥¼ ì°¾ìœ¼ë ¤ë©´ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
                        break;
                    case error.POSITION_UNAVAILABLE:
                        showErrorMessage('ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        break;
                    case error.TIMEOUT:
                        showErrorMessage('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        break;
                    default:
                        showErrorMessage(`Geolocation ì˜¤ë¥˜: ${error.message}`);
                }
                hideLoading();
            });
        }


        // ====== UI ë Œë”ë§ í•¨ìˆ˜ ======
        function displayFestivals(festivals) {
            if (!festivals || festivals.length === 0) {
                if (currentPage === 1) { // Only show no results if it's the first page
                    showNoResults();
                } else { // If loading more and no new results, just hide load more button
                    loadMoreButton.classList.add('hidden');
                }
                return;
            }

            hideNoResults();

            festivals.forEach(festival => {
                const status = getFestivalStatus(festival.eventstartdate, festival.eventenddate);
                const card = document.createElement('div');
                card.className = 'festival-card cursor-pointer';
                card.innerHTML = `
                    <div class="relative w-full h-48 bg-gray-200 overflow-hidden">
                        <img src="${festival.firstimage || 'https://placehold.co/500x300/e0e0e0/555555?text=No+Image'}"
                             alt="${festival.title || 'ì¶•ì œ ì´ë¯¸ì§€'}"
                             class="w-full h-full object-cover"
                             onerror="this.onerror=null;this.src='https://placehold.co/500x300/e0e0e0/555555?text=No+Image';" />
                        <span class="absolute top-3 left-3 status-badge ${status.class}">${status.text}</span>
                    </div>
                    <div class="p-5 flex-grow flex flex-col">
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">${festival.title || 'ì œëª© ì—†ìŒ'}</h3>
                        <p class="text-sm text-gray-600 mb-1">
                            <strong>ê¸°ê°„:</strong> ${formatDate(festival.eventstartdate)} ~ ${formatDate(festival.eventenddate)}
                        </p>
                        <p class="text-sm text-gray-600 mb-3">
                            <strong>ì¥ì†Œ:</strong> ${festival.addr1 || 'ì¥ì†Œ ë¯¸ì •'}
                        </p>
                        ${festival.distance ? `<p class="text-sm text-gray-700 font-medium mt-auto"><strong>ê±°ë¦¬:</strong> ì•½ ${festival.distance}m</p>` : ''}
                    </div>
                `;
                card.onclick = () => openDetailModal(festival.contentid, festival.contentTypeId);
                festivalListDiv.appendChild(card);
            });
        }

        async function openDetailModal(contentId, contentTypeId) {
            const modal = document.getElementById('detailModal');
            const modalContentDiv = document.getElementById('modalContent');
            modalContentDiv.innerHTML = '<div class="flex justify-center items-center h-48"><div class="loading-spinner"></div></div>';
            modal.style.display = 'flex';

            try {
                // ê³µí†µ ì •ë³´ ì¡°íšŒ
                const commonData = await fetchAPI('detailCommon2', {
                    contentId: contentId,
                    MobileOS: 'WEB',
                    MobileApp: 'HealingKApp'
                });
                const commonItem = commonData.items.item[0];

                // ì†Œê°œ ì •ë³´ ì¡°íšŒ
                const introData = await fetchAPI('detailIntro2', {
                    contentId: contentId,
                    contentTypeId: contentTypeId,
                    MobileOS: 'WEB',
                    MobileApp: 'HealingKApp'
                });
                const introItem = introData.items.item[0];

                // ì´ë¯¸ì§€ ì •ë³´ ì¡°íšŒ
                const imageData = await fetchAPI('detailImage2', {
                    contentId: contentId,
                    imageYN: 'Y',
                    MobileOS: 'WEB',
                    MobileApp: 'HealingKApp'
                });
                const images = Array.isArray(imageData.items.item) ? imageData.items.item : (imageData.items.item ? [imageData.items.item] : []);

                let homepageLink = commonItem.homepage ? commonItem.homepage.replace(/<[^>]*>/g, '') : 'ì •ë³´ ì—†ìŒ'; // HTML íƒœê·¸ ì œê±°
                if (homepageLink && !homepageLink.startsWith('http')) {
                    homepageLink = `http://${homepageLink}`; // ë§í¬ê°€ http:// ë˜ëŠ” https://ë¡œ ì‹œì‘í•˜ì§€ ì•ŠëŠ” ê²½ìš° ë³´ì •
                }

                modalContentDiv.innerHTML = `
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">${commonItem.title || 'ì œëª© ì—†ìŒ'}</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="flex flex-col">
                            ${images.length > 0 ? `
                                <img src="${images[0].originimgurl || 'https://placehold.co/800x600/e0e0e0/555555?text=No+Image'}"
                                     alt="${commonItem.title || 'ì¶•ì œ ì´ë¯¸ì§€'}"
                                     class="w-full h-auto rounded-lg shadow-md mb-4"
                                     onerror="this.onerror=null;this.src='https://placehold.co/800x600/e0e0e0/555555?text=No+Image';" />
                            ` : `
                                <img src="https://placehold.co/800x600/e0e0e0/555555?text=No+Image"
                                     alt="ì´ë¯¸ì§€ ì—†ìŒ"
                                     class="w-full h-auto rounded-lg shadow-md mb-4" />
                            `}
                            ${images.length > 1 ? `
                                <div class="grid grid-cols-3 gap-2 overflow-x-auto">
                                    ${images.slice(1).map(img => `
                                        <img src="${img.smallimageurl || 'https://placehold.co/150x100/e0e0e0/555555?text=No+Image'}"
                                             alt="${img.imgname || 'ì¶•ì œ ì„œë¸Œ ì´ë¯¸ì§€'}"
                                             class="w-full h-20 object-cover rounded-md cursor-pointer hover:opacity-80 transition-opacity"
                                             onclick="this.closest('.modal-content').querySelector('img').src = '${img.originimgurl || 'https://placehold.co/800x600/e0e0e0/555555?text=No+Image'}';"
                                             onerror="this.onerror=null;this.src='https://placehold.co/150x100/e0e0e0/555555?text=No+Image';" />
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                        <div>
                            <p class="text-lg text-gray-700 mb-2"><strong>ì¥ì†Œ:</strong> ${commonItem.addr1 || 'ì •ë³´ ì—†ìŒ'} ${commonItem.addr2 || ''}</p>
                            <p class="text-lg text-gray-700 mb-2"><strong>ì „í™”:</strong> ${commonItem.tel || 'ì •ë³´ ì—†ìŒ'}</p>
                            <p class="text-lg text-gray-700 mb-2"><strong>í™ˆí˜ì´ì§€:</strong>
                                ${homepageLink !== 'ì •ë³´ ì—†ìŒ' ? `<a href="${homepageLink}" target="_blank" class="text-blue-600 hover:underline">${homepageLink}</a>` : 'ì •ë³´ ì—†ìŒ'}
                            </p>
                            <p class="text-lg text-gray-700 mb-2"><strong>ê°œì¥ì¼:</strong> ${introItem.opendate || 'ì •ë³´ ì—†ìŒ'}</p>
                            <p class="text-lg text-gray-700 mb-2"><strong>ì‰¬ëŠ”ë‚ :</strong> ${introItem.restdate || 'ì •ë³´ ì—†ìŒ'}</p>
                            <p class="text-lg text-gray-700 mb-2"><strong>ì´ìš©ì‹œê°„:</strong> ${introItem.usetime || 'ì •ë³´ ì—†ìŒ'}</p>
                            <p class="text-lg text-gray-700 mb-2"><strong>ì£¼ì°¨ì‹œì„¤:</strong> ${introItem.parking || 'ì •ë³´ ì—†ìŒ'}</p>
                            ${introItem.usetimefestival ? `<p class="text-lg text-gray-700 mb-2"><strong>ì´ìš©ìš”ê¸ˆ:</strong> ${introItem.usetimefestival}</p>` : ''}
                            ${introItem.eventplace ? `<p class="text-lg text-gray-700 mb-2"><strong>í–‰ì‚¬ì¥ì†Œ:</strong> ${introItem.eventplace}</p>` : ''}
                            ${introItem.program ? `<p class="text-lg text-gray-700 mb-2"><strong>í”„ë¡œê·¸ë¨:</strong> ${introItem.program}</p>` : ''}

                            <h3 class="text-xl font-semibold text-gray-800 mt-6 mb-2">ê°œìš”</h3>
                            <div class="text-base text-gray-700 leading-relaxed overflow-y-auto max-h-60 rounded-md p-3 bg-gray-50 border border-gray-200">
                                ${commonItem.overview ? commonItem.overview.replace(/<br\s*\/?>/gi, '\n').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&').replace(/&quot;/g, '"').replace(/&#39;/g, "'") : 'ìƒì„¸ ê°œìš” ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'}
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                modalContentDiv.innerHTML = `<div class="error-message">ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
                console.error('ìƒì„¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
            }
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
            document.getElementById('modalContent').innerHTML = ''; // Clear content on close
        }

        // ====== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ======
        document.getElementById('searchButton').addEventListener('click', () => fetchFestivals(true));
        document.getElementById('resetButton').addEventListener('click', () => {
            keywordInput.value = '';
            areaCodeSelect.value = '';
            startDateInput.value = ''; 
            endDateInput.value = '';
            statusFilterSelect.value = 'all';
            fetchFestivals(true); // Reset and fetch
        });
        document.getElementById('nearMeButton').addEventListener('click', fetchNearByFestivals);
        loadMoreButton.addEventListener('click', () => {
            currentPage++;
            fetchFestivals(false);
        });
        statusFilterSelect.addEventListener('change', () => {
            currentStatusFilter = statusFilterSelect.value;
            // Re-fetch with current filters, but re-render from page 1
            // A more efficient way would be to re-filter the already loaded items if the filter is client-side.
            // For simplicity and given the API structure, we'll re-fetch.
            fetchFestivals(true);
        });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target == modal) {
                closeModal();
            }
        }
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && document.getElementById('detailModal').style.display === 'flex') {
                closeModal();
            }
        });

        // ì´ˆê¸° ë¡œë”©
        document.addEventListener('DOMContentLoaded', () => {
            fetchAreaCodes();
            fetchFestivals(true);
        });
    </script>
</body>
</html>
