<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë‚ ì”¨ API ë””ë²„ê¹…</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .test-result { margin: 15px 0; padding: 15px; border-radius: 8px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .test-btn { background: #007bff; color: white; }
        .debug-btn { background: #28a745; color: white; }
        .url-display { background: #e9ecef; padding: 10px; border-radius: 4px; font-family: monospace; }
    </style>
</head>
<body>
    <h1>ğŸŒ¤ï¸ ë‚ ì”¨ API ì™„ì „ ë””ë²„ê¹…</h1>
    
    <div class="test-result info">
        <h3>ğŸ” í˜„ì¬ í™˜ê²½ ì •ë³´</h3>
        <div class="url-display">
            <p><strong>í˜„ì¬ í˜ì´ì§€:</strong> <span id="currentUrl"></span></p>
            <p><strong>ê°ì§€ëœ Base URL:</strong> <span id="detectedUrl"></span></p>
            <p><strong>í…ŒìŠ¤íŠ¸í•  API URL:</strong> <span id="testApiUrl"></span></p>
        </div>
    </div>
    
    <div>
        <button class="debug-btn" onclick="checkEndpoints()">ğŸ”§ API ì—”ë“œí¬ì¸íŠ¸ ì²´í¬</button>
        <button class="debug-btn" onclick="testConnection()">ğŸŒ ì—°ê²° í…ŒìŠ¤íŠ¸</button>
        <button class="test-btn" onclick="testWeatherAPI('ì„œìš¸')">ì„œìš¸ ë‚ ì”¨ í…ŒìŠ¤íŠ¸</button>
        <button class="test-btn" onclick="testDirectAPI()">ì§ì ‘ API í…ŒìŠ¤íŠ¸</button>
    </div>

    <div id="results"></div>

    <script>
        // ë™ì  URL ê°ì§€
        const currentHost = window.location.hostname;
        const currentProtocol = window.location.protocol;
        let baseURL;

        if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
            baseURL = 'http://localhost:3000';
        } else {
            baseURL = `${currentProtocol}//${currentHost}`;
        }

        // í™˜ê²½ ì •ë³´ í‘œì‹œ
        document.getElementById('currentUrl').textContent = window.location.href;
        document.getElementById('detectedUrl').textContent = baseURL;
        document.getElementById('testApiUrl').textContent = `${baseURL}/api/weather`;

        const resultsDiv = document.getElementById('results');

        function addResult(content, type = 'info') {
            resultsDiv.innerHTML += `<div class="test-result ${type}">${content}</div>`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        // API ì—”ë“œí¬ì¸íŠ¸ ì¡´ì¬ í™•ì¸
        async function checkEndpoints() {
            addResult('<h3>ğŸ”§ API ì—”ë“œí¬ì¸íŠ¸ ì²´í¬ ì¤‘...</h3>', 'info');
            
            const endpoints = [
                '/api/weather',
                '/api/air-quality', 
                '/api/festivals',
                '/api/tourism',
                '/api/combined',
                '/api/ranking'
            ];

            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`${baseURL}${endpoint}?region=ì„œìš¸`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    const status = response.status;
                    const statusText = response.statusText;
                    
                    if (status === 200) {
                        addResult(`âœ… <strong>${endpoint}</strong>: ì •ìƒ (${status})`, 'success');
                    } else {
                        addResult(`âš ï¸ <strong>${endpoint}</strong>: ì‘ë‹µ ìˆìŒ (${status} ${statusText})`, 'warning');
                    }
                } catch (error) {
                    addResult(`âŒ <strong>${endpoint}</strong>: ì‹¤íŒ¨ - ${error.message}`, 'error');
                }
            }
        }

        // ê¸°ë³¸ ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testConnection() {
            addResult('<h3>ğŸŒ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...</h3>', 'info');
            
            try {
                // 1. ë£¨íŠ¸ ê²½ë¡œ í…ŒìŠ¤íŠ¸
                const rootResponse = await fetch(baseURL);
                addResult(`âœ… ë£¨íŠ¸ ì ‘ì†: ${rootResponse.status} ${rootResponse.statusText}`, 'success');
                
                // 2. CORS í…ŒìŠ¤íŠ¸
                const corsResponse = await fetch(`${baseURL}/api/weather`, {
                    method: 'OPTIONS'
                });
                addResult(`âœ… CORS í”„ë¦¬í”Œë¼ì´íŠ¸: ${corsResponse.status}`, 'success');
                
            } catch (error) {
                addResult(`âŒ ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // í–¥ìƒëœ ë‚ ì”¨ API í…ŒìŠ¤íŠ¸
        async function testWeatherAPI(region) {
            const timestamp = new Date().toLocaleString('ko-KR');
            addResult(`<h3>ğŸ”„ ${region} ë‚ ì”¨ API í…ŒìŠ¤íŠ¸ ì‹œì‘</h3><p>ì‹œê°„: ${timestamp}</p>`, 'info');

            try {
                const url = `${baseURL}/api/weather?region=${encodeURIComponent(region)}`;
                addResult(`<p><strong>ìš”ì²­ URL:</strong> ${url}</p>`, 'info');

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15ì´ˆ íƒ€ì„ì•„ì›ƒ

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                addResult(`<p><strong>ì‘ë‹µ ìƒíƒœ:</strong> ${response.status} ${response.statusText}</p>`, 
                    response.ok ? 'success' : 'warning');

                const contentType = response.headers.get('content-type');
                addResult(`<p><strong>Content-Type:</strong> ${contentType}</p>`, 'info');

                if (!response.ok) {
                    const errorText = await response.text();
                    addResult(`<h3>âŒ HTTP ì˜¤ë¥˜</h3><pre>${errorText}</pre>`, 'error');
                    return;
                }

                const data = await response.json();
                
                addResult(`<h3>âœ… ${region} ë‚ ì”¨ ë°ì´í„° ì„±ê³µ!</h3>
                    <p><strong>ì„±ê³µ:</strong> ${data.success}</p>
                    <p><strong>ì˜¨ë„:</strong> ${data.data?.temperature}Â°C</p>
                    <p><strong>ë‚ ì”¨:</strong> ${data.data?.sky}</p>
                    <p><strong>ê°•ìˆ˜:</strong> ${data.data?.precipitation}</p>
                    <p><strong>ë©”ì‹œì§€:</strong> ${data.data?.message}</p>
                    <details>
                        <summary>ğŸ“‹ ì „ì²´ ì‘ë‹µ ë°ì´í„°</summary>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </details>`, 'success');

            } catch (error) {
                if (error.name === 'AbortError') {
                    addResult(`<h3>â° ${region} ë‚ ì”¨ í…ŒìŠ¤íŠ¸ íƒ€ì„ì•„ì›ƒ</h3>
                        <p>15ì´ˆ ë‚´ì— ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`, 'error');
                } else {
                    addResult(`<h3>âŒ ${region} ë‚ ì”¨ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨</h3>
                        <p><strong>ì˜¤ë¥˜ íƒ€ì…:</strong> ${error.name}</p>
                        <p><strong>ì˜¤ë¥˜ ë©”ì‹œì§€:</strong> ${error.message}</p>
                        <details>
                            <summary>ğŸ” ìƒì„¸ ì˜¤ë¥˜ ì •ë³´</summary>
                            <pre>${error.stack}</pre>
                        </details>`, 'error');
                }
            }
        }

        // ì§ì ‘ ì™¸ë¶€ API í…ŒìŠ¤íŠ¸ (ê°œë°œìš©)
        async function testDirectAPI() {
            addResult('<h3>ğŸŒ ì™¸ë¶€ API ì§ì ‘ í…ŒìŠ¤íŠ¸</h3>', 'info');
            
            try {
                // ê³µê°œ ë‚ ì”¨ APIë¡œ ì—°ê²° í…ŒìŠ¤íŠ¸
                const testResponse = await fetch('https://api.openweathermap.org/data/2.5/weather?q=Seoul&appid=demo');
                addResult(`ì™¸ë¶€ API ì—°ê²°: ${testResponse.status} (OpenWeather í…ŒìŠ¤íŠ¸)`, 
                    testResponse.status === 401 ? 'warning' : 'info'); // 401ì€ APIí‚¤ ì—†ìŒì´ë¯€ë¡œ ì—°ê²°ì€ ë¨
                    
            } catch (error) {
                addResult(`ì™¸ë¶€ API ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ìë™ ì´ˆê¸° í…ŒìŠ¤íŠ¸
        window.onload = async () => {
            addResult('<h3>ğŸš€ ìë™ ì´ˆê¸° ì§„ë‹¨ ì‹œì‘</h3>', 'info');
            await checkEndpoints();
            await testConnection();
            
            // 3ì´ˆ í›„ ì‹¤ì œ API í…ŒìŠ¤íŠ¸
            setTimeout(() => {
                testWeatherAPI('ì„œìš¸');
            }, 3000);
        };
    </script>
</body>
</html>
