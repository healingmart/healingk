<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íë§K ì¶•ì œ ìœ„ì ¯ (API ì—°ë™)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        .festival-widget {
            max-width: 450px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 20px;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            margin: 20px auto;
        }
        
        .widget-header { text-align: center; margin-bottom: 20px; }
        .widget-title { font-size: 1.4rem; font-weight: 700; margin-bottom: 5px; }
        .widget-subtitle { font-size: 0.9rem; opacity: 0.9; }
        
        .festival-tabs { display: flex; background: rgba(255,255,255,0.1); border-radius: 10px; padding: 4px; margin-bottom: 15px; }
        .tab-btn { flex: 1; background: none; border: none; color: white; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 0.8rem; font-weight: 500; transition: all 0.3s ease; }
        .tab-btn.active { background: rgba(255,255,255,0.25); font-weight: 700; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        #festival-content { min-height: 100px; }
        .festival-list { max-height: 320px; overflow-y: auto; padding-right: 5px; }
        
        .festival-item {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 12px 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }
        .festival-item:hover { background: rgba(255,255,255,0.18); transform: translateX(3px); border-left-color: rgba(255,255,255,0.5); }
        
        .festival-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
        .festival-title-link { font-size: 0.95rem; font-weight: 600; flex: 1; margin-right: 10px; line-height: 1.3; color: white; text-decoration: none;}
        .festival-title-link:hover { text-decoration: underline; }

        .festival-status { background: rgba(0,0,0,0.2); color: white; padding: 3px 8px; border-radius: 15px; font-size: 0.7rem; font-weight: 500; white-space: nowrap; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .festival-status.ongoing { background: #2ecc71; }
        .festival-status.upcoming { background: #3498db; }
        .festival-status.weekend { background: #f1c40f; color: #333; }
        .festival-status.past { background: #95a5a6; }
        
        .festival-details { font-size: 0.8rem; opacity: 0.9; display: flex; justify-content: space-between; align-items: center; margin-top: 4px; }
        .festival-location { flex: 1; display: flex; align-items: center; }
        .festival-location::before { content: 'ğŸ“'; margin-right: 5px; font-size: 0.9em; }
        .festival-date { font-size: 0.75rem; opacity: 0.85; font-weight: 500; }

        .festival-extras {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.15);
            font-size: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .festival-weather-info span { /* í´ë˜ìŠ¤ëª… ë³€ê²½ */
            display: flex;
            align-items: center;
        }
        .festival-weather-info .weather-icon {
            font-size: 1.1em; 
            margin-right: 5px;
        }
        .official-link a {
            color: #e0e7ff; 
            text-decoration: none;
            font-weight: 500;
            padding: 3px 7px;
            border-radius: 5px;
            background-color: rgba(0,0,0,0.15);
            transition: background-color 0.2s ease;
        }
        .official-link a:hover {
            background-color: rgba(0,0,0,0.3);
            text-decoration: underline;
        }
        
        .festival-stats { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 12px 15px; margin-top: 20px; font-size: 0.85rem; }
        .stats-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .stats-row:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        .stats-row span:first-child { opacity: 0.9; }
        .stats-row span:last-child { font-weight: 600; }
        
        .widget-footer { text-align: center; margin-top: 20px; font-size: 0.75rem; opacity: 0.8; }
        .widget-footer span[onclick] { text-decoration: underline; font-weight: 500; }
        
        .loading, .no-festivals { text-align: center; padding: 30px 20px; font-size: 0.95rem; opacity: 0.85; font-weight: 500; }
        
        .festival-list::-webkit-scrollbar { width: 5px; }
        .festival-list::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 10px; }
        .festival-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.35); border-radius: 10px; }
        .festival-list::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.5); }
    </style>
</head>
<body>
    <div class="festival-widget">
        <div class="widget-header">
            <div class="widget-title">ğŸ‰ ëŒ€í•œë¯¼êµ­ ì¶•ì œ ì •ë³´</div>
            <div class="widget-subtitle">ì˜¤ëŠ˜ì˜ ì¶•ì œì™€ ë‚ ì”¨ë¥¼ í•œëˆˆì—!</div>
        </div>
        
        <div class="festival-tabs">
            <button class="tab-btn active" data-tab="ongoing">ì§„í–‰ì¤‘</button>
            <button class="tab-btn" data-tab="weekend">ì£¼ë§ ì˜ˆì •</button>
            <button class="tab-btn" data-tab="upcoming">ì „ì²´ ì˜ˆì •</button>
        </div>
        
        <div id="festival-content">
            <div class="loading">ì¶•ì œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
        </div>
        
        <div class="festival-stats" id="festival-stats-display" style="display: none;">
            <div class="stats-row">
                <span>ğŸ‰ ì „ì²´ ì¶•ì œ ìˆ˜ (ì˜ˆì • í¬í•¨)</span>
                <span id="total-count">-</span>
            </div>
            <div class="stats-row">
                <span>ğŸ”¥ í˜„ì¬ ì§„í–‰ì¤‘</span>
                <span id="ongoing-count">-</span>
            </div>
            <div class="stats-row">
                <span>ğŸŒŸ ê°€ì¥ ì¸ê¸°ìˆëŠ” ì§€ì—­</span>
                <span id="popular-region">-</span>
            </div>
        </div>
        
        <div class="widget-footer">
            <span id="update-time">ì—…ë°ì´íŠ¸: ì •ë³´ ì—†ìŒ</span> â€¢ 
            <span onclick="refreshFestival()" style="cursor: pointer;">ìƒˆë¡œê³ ì¹¨</span>
        </div>
    </div>

    <script>
        let currentTab = 'ongoing';
        let rawFestivalData = []; 

        // --- API URL ì •ì˜ ---
        // !!! ì¤‘ìš”: ì‹¤ì œ API ì—”ë“œí¬ì¸íŠ¸ URLë¡œ ë³€ê²½í•´ì£¼ì„¸ìš” !!!
        // ì˜ˆì‹œ: const FESTIVALS_API_URL = 'https://healingk.vercel.app/api/festivals';
        // ì˜ˆì‹œ: const WEATHER_API_URL = 'https://healingk.vercel.app/api/weather'; 
        const FESTIVALS_API_URL = '/api/festivals'; // ì¶•ì œ ì •ë³´ API (ìƒëŒ€ ê²½ë¡œ ê°€ì •)
        const WEATHER_API_URL = '/api/weather';   // ë‚ ì”¨ ì •ë³´ API (ìƒëŒ€ ê²½ë¡œ ê°€ì •)
        // --- API URL ì •ì˜ ë ---

        document.addEventListener('DOMContentLoaded', function() {
            loadFestivalData();
            setupTabs();
            setInterval(loadFestivalData, 10 * 60 * 1000); 
        });
        
        function setupTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentTab = this.dataset.tab;
                    renderFestivals();
                });
            });
        }
        
        async function loadFestivalData() {
            const festivalContentEl = document.getElementById('festival-content');
            if (document.querySelector('.festival-list')) { 
                 festivalContentEl.innerHTML = '<div class="loading">ìƒˆë¡œìš´ ì •ë³´ í™•ì¸ ì¤‘...</div>';
            } else {
                 festivalContentEl.innerHTML = '<div class="loading">ì¶•ì œ ì •ë³´ ë¡œë”© ì¤‘...</div>';
            }
            
            try {
                console.log(`Fetching festivals from: ${FESTIVALS_API_URL}`);
                const response = await fetch(FESTIVALS_API_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Festivals API status: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                console.log('Fetched festival data structure:', data);

                if (data && Array.isArray(data)) {
                    rawFestivalData = data;
                } else if (data && data.success && Array.isArray(data.data)) {
                     rawFestivalData = data.data;
                } else if (data && data.items && Array.isArray(data.items)) { // ê³µê³µë°ì´í„°í¬í„¸ ê´€ê´‘ì •ë³´ì„œë¹„ìŠ¤ ì¶•ì œì¡°íšŒ ì°¸ê³ 
                    rawFestivalData = data.items.item.map(d => ({ // ë°ì´í„° êµ¬ì¡° ë§¤í•‘ ì˜ˆì‹œ
                        id: d.contentid,
                        title: d.title,
                        region: d.addr1?.split(' ')[0] || 'ì •ë³´ì—†ìŒ', // ì£¼ì†Œì—ì„œ ì²« ë‹¨ì–´ ì¶”ì¶œ
                        location: d.addr1 || 'ì •ë³´ì—†ìŒ',
                        startDate: d.eventstartdate ? `${d.eventstartdate.slice(0,4)}-${d.eventstartdate.slice(4,6)}-${d.eventstartdate.slice(6,8)}` : null,
                        endDate: d.eventenddate ? `${d.eventenddate.slice(0,4)}-${d.eventenddate.slice(4,6)}-${d.eventenddate.slice(6,8)}` : null,
                        officialLink: d.homepage || '#',
                        // ë‚ ì”¨ëŠ” ê° í•­ëª© ë Œë”ë§ ì‹œ ë³„ë„ í˜¸ì¶œ, region ì •ë³´ëŠ” ì—¬ê¸°ì„œ í™•ë³´
                    }));
                } else {
                    console.warn('Festival API ì‘ë‹µì´ ì˜ˆìƒí•œ ë°°ì—´ í˜•íƒœê°€ ì•„ë‹™ë‹ˆë‹¤. ë°ì´í„° êµ¬ì¡°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    rawFestivalData = [];
                }
                
                renderFestivals(); // ë‚ ì”¨ ì •ë³´ëŠ” renderFestivals ë‚´ë¶€ì—ì„œ ê° í•­ëª©ë³„ë¡œ í˜¸ì¶œ
                updateStats();
                document.getElementById('update-time').textContent = `ì—…ë°ì´íŠ¸: ${new Date().toLocaleTimeString('ko-KR')}`;

            } catch (error) {
                console.error('ì¶•ì œ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                showError(`ì¶•ì œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì˜¤ë¥˜: ${error.message})`);
            }
        }

        async function fetchAndDisplayWeather(region, weatherElement) {
            if (!region || !weatherElement) return;

            const weatherIconEl = weatherElement.querySelector('.weather-icon');
            const weatherTempEl = weatherElement.querySelector('.weather-temp');
            const weatherDescEl = weatherElement.querySelector('.weather-description');

            if (!weatherIconEl || !weatherTempEl || !weatherDescEl) {
                console.warn("Weather display elements not found in:", weatherElement);
                return;
            }
            
            weatherIconEl.textContent = 'â³';
            weatherTempEl.textContent = '--Â°C';
            weatherDescEl.textContent = 'ë¡œë”©ì¤‘';

            try {
                const weatherResponse = await fetch(`${WEATHER_API_URL}?region=${encodeURIComponent(region)}`);
                if (!weatherResponse.ok) {
                    throw new Error(`Weather API status: ${weatherResponse.status}`);
                }
                const weatherData = await weatherResponse.json();

                if (weatherData.success && weatherData.data) {
                    const { temperature, sky } = weatherData.data;
                    let skyIcon = 'â“';
                    if (sky === 'ë§‘ìŒ') skyIcon = 'â˜€ï¸';
                    else if (sky === 'êµ¬ë¦„ë§ìŒ') skyIcon = 'ğŸŒ¥ï¸';
                    else if (sky === 'íë¦¼') skyIcon = 'â˜ï¸';
                    
                    weatherIconEl.textContent = skyIcon;
                    weatherTempEl.textContent = `${temperature}Â°C`;
                    weatherDescEl.textContent = sky;
                } else {
                    throw new Error(weatherData.data?.message || 'ë‚ ì”¨ ì •ë³´ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error(`ë‚ ì”¨ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜ (${region}):`, error);
                weatherIconEl.textContent = 'âš ï¸';
                weatherTempEl.textContent = '';
                weatherDescEl.textContent = 'ì‹¤íŒ¨';
            }
        }


        function getFestivalDynamicInfo(festival, today) {
            if (!festival.startDate) { // í•„ìˆ˜ ì •ë³´ ëˆ„ë½ ì‹œ
                return { status: 'unknown', statusText: 'ì •ë³´ì—†ìŒ', dateDisplay: 'ë‚ ì§œì •ë³´ì—†ìŒ', startDateObj: null, endDateObj: null };
            }
            const startDate = new Date(festival.startDate);
            const endDate = festival.endDate && festival.endDate !== festival.startDate ? new Date(festival.endDate) : new Date(festival.startDate);
            endDate.setHours(23, 59, 59, 999);

            let status = 'upcoming';
            let statusText = 'ì˜ˆì •';
            let dateDisplay = `${formatDate(startDate)}`;
            if (startDate.toDateString() !== endDate.toDateString()) {
                 dateDisplay += ` ~ ${formatDate(endDate)}`;
            }

            if (startDate <= today && today <= endDate) {
                status = 'ongoing';
                statusText = 'ì§„í–‰ì¤‘';
                const diffTimeMs = endDate.getTime() - today.getTime(); // getTime() ì¶”ê°€
                const diffDays = Math.max(0, Math.ceil(diffTimeMs / (1000 * 60 * 60 * 24)));
                if (endDate.toDateString() === today.toDateString()) {
                    dateDisplay = 'ì˜¤ëŠ˜ê¹Œì§€!';
                } else {
                    dateDisplay = `${diffDays}ì¼ ë‚¨ìŒ`;
                }
            } else if (startDate > today) {
                status = 'upcoming';
                statusText = 'ì˜ˆì •';
                const diffTimeMs = startDate.getTime() - today.getTime(); // getTime() ì¶”ê°€
                const diffDays = Math.ceil(diffTimeMs / (1000 * 60 * 60 * 24));
                dateDisplay = `D-${diffDays}`;
                 if (startDate.toDateString() === today.toDateString()){
                     dateDisplay = "ì˜¤ëŠ˜ ì‹œì‘";
                }
            } else if (endDate < today) {
                status = 'past';
                statusText = 'ì¢…ë£Œ';
                dateDisplay = `ì¢…ë£Œë¨ (${formatDate(endDate)})`;
            }
            return { status, statusText, dateDisplay, startDateObj: startDate, endDateObj: endDate };
        }

        function formatDate(date) {
            if (!(date instanceof Date) || isNaN(date)) return "ë‚ ì§œì˜¤ë¥˜";
            return `${date.getMonth() + 1}ì›” ${date.getDate()}ì¼`;
        }
        
        function renderFestivals() {
            const content = document.getElementById('festival-content');
             if (!rawFestivalData && !document.querySelector('.loading')) {
                content.innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</div>';
                return;
            }
            if (rawFestivalData.length === 0 && !document.querySelector('.loading')) {
                 content.innerHTML = '<div class="no-festivals">í‘œì‹œí•  ì¶•ì œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                 return;
            }
            if (rawFestivalData.length === 0 && document.querySelector('.loading')) {
                return; 
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0); 

            rawFestivalData.forEach(fest => {
                fest.dynamicInfo = getFestivalDynamicInfo(fest, today);
            });

            let festivalsToDisplay = [];
            if (currentTab === 'ongoing') {
                festivalsToDisplay = rawFestivalData.filter(f => f.dynamicInfo.status === 'ongoing');
            } else if (currentTab === 'weekend') {
                const dayOfWeek = today.getDay();
                const nextSaturday = new Date(today);
                nextSaturday.setDate(today.getDate() + ( (6 - dayOfWeek + 7) % 7 ) ); 
                const nextSunday = new Date(nextSaturday);
                nextSunday.setDate(nextSaturday.getDate() + 1);

                festivalsToDisplay = rawFestivalData.filter(f => {
                    const festStart = f.dynamicInfo.startDateObj;
                    const festEnd = f.dynamicInfo.endDateObj;
                    return festStart && festEnd && (festStart <= nextSunday && festEnd >= nextSaturday) && f.dynamicInfo.status !== 'past';
                });
            } else if (currentTab === 'upcoming') {
                festivalsToDisplay = rawFestivalData.filter(f => f.dynamicInfo.status === 'upcoming' || 
                                                              (f.dynamicInfo.status === 'ongoing' && f.dynamicInfo.startDateObj && f.dynamicInfo.startDateObj > today)
                                                             );
            }
            
            festivalsToDisplay.sort((a, b) => {
                if (!a.dynamicInfo.startDateObj || !b.dynamicInfo.startDateObj) return 0;
                return a.dynamicInfo.startDateObj - b.dynamicInfo.startDateObj;
            });

            if (festivalsToDisplay.length === 0) {
                content.innerHTML = `
                    <div class="no-festivals">
                        ${currentTab === 'ongoing' ? 'í˜„ì¬ ì§„í–‰ì¤‘ì¸ ì¶•ì œê°€ ì—†ìŠµë‹ˆë‹¤.' : 
                          currentTab === 'weekend' ? 'ì´ë²ˆ ì£¼ë§ì— ì˜ˆì •ëœ ì¶•ì œê°€ ì—†ìŠµë‹ˆë‹¤.' : 
                          'ì˜ˆì •ëœ ì¶•ì œê°€ ì—†ìŠµë‹ˆë‹¤.'}
                    </div>
                `;
                return;
            }
            
            const listElement = document.createElement('div');
            listElement.className = 'festival-list';

            festivalsToDisplay.slice(0, 10).forEach(festival => {
                const { status, statusText, dateDisplay } = festival.dynamicInfo;
                
                const itemElement = document.createElement('div');
                itemElement.className = 'festival-item';
                itemElement.title = `${festival.title} - ${festival.region || ''} ${festival.location || ''}`;
                itemElement.onclick = () => openFestivalDetail(festival.id);

                itemElement.innerHTML = `
                    <div class="festival-header">
                        <a href="${festival.officialLink || '#'}" target="_blank" class="festival-title-link" onclick="handleLinkClick(event, '${festival.officialLink}')">${festival.title || 'ì œëª© ì—†ìŒ'}</a>
                        <div class="festival-status ${status}">${statusText}</div>
                    </div>
                    <div class="festival-details">
                        <div class="festival-location">${festival.region || ''} ${festival.location && festival.location.length > 12 ? festival.location.slice(0, 12) + 'â€¦' : festival.location || ''}</div>
                        <div class="festival-date">${dateDisplay}</div>
                    </div>
                    <div class="festival-extras">
                        <div class="festival-weather-info">
                            <span class="weather-icon"></span>
                            <span class="weather-temp" style="margin-left: 4px;"></span>
                            <span class="weather-description" style="margin-left: 4px; font-size: 0.9em; opacity: 0.8;"></span>
                        </div>
                        ${festival.officialLink && festival.officialLink !== '#' ? 
                            `<div class="official-link"><a href="${festival.officialLink}" target="_blank" onclick="handleLinkClick(event, '${festival.officialLink}')"><i class="fas fa-link"></i> í™ˆí˜ì´ì§€</a></div>` : 
                            ''}
                    </div>
                `;
                listElement.appendChild(itemElement);
                // ê° ì•„ì´í…œì— ëŒ€í•´ ë‚ ì”¨ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const weatherDisplayElement = itemElement.querySelector('.festival-weather-info');
                if (festival.region && weatherDisplayElement) {
                    fetchAndDisplayWeather(festival.region, weatherDisplayElement);
                } else if (weatherDisplayElement) {
                    weatherDisplayElement.querySelector('.weather-description').textContent = 'ì§€ì—­ì •ë³´ì—†ìŒ';
                }
            });
            content.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì§€ìš°ê¸°
            content.appendChild(listElement);
        }
        
        function handleLinkClick(event, url) {
            if (!url || url === '#') {
                event.preventDefault(); 
                console.log('ê³µì‹ í™ˆí˜ì´ì§€ ì •ë³´ ì—†ìŒ');
            }
            event.stopPropagation(); // ë¶€ëª¨ divì˜ onclick ì´ë²¤íŠ¸ ì „íŒŒ ë§‰ê¸°
        }

        function updateStats() {
            const statsDisplay = document.getElementById('festival-stats-display');
             if (!rawFestivalData || rawFestivalData.length === 0) {
                statsDisplay.style.display = 'none';
                return;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let ongoingCount = 0;
            let upcomingAndWeekendCount = 0; // ì£¼ë§ í¬í•¨ ì˜ˆì •

            rawFestivalData.forEach(f => {
                // dynamicInfoê°€ ì—†ìœ¼ë©´ ê³„ì‚° (renderFestivalsì—ì„œ ì´ë¯¸ ê³„ì‚°í–ˆì„ ìˆ˜ ìˆìŒ)
                if (!f.dynamicInfo) {
                    f.dynamicInfo = getFestivalDynamicInfo(f, today);
                }
                if (f.dynamicInfo.status === 'ongoing') {
                    ongoingCount++;
                }
                if (f.dynamicInfo.status === 'upcoming' || 
                   (f.dynamicInfo.status === 'ongoing' && f.dynamicInfo.startDateObj > today) || // ì˜¤ëŠ˜ ì´í›„ ì‹œì‘í•˜ëŠ” ì§„í–‰ì¤‘
                   isWeekendFestival(f, today) ) { // ì£¼ë§ ì¶•ì œ (ì¤‘ë³µë  ìˆ˜ ìˆìœ¼ë‚˜, 'ì˜ˆì •' ì¹´í…Œê³ ë¦¬ì— í¬í•¨ë  ìˆ˜ ìˆëŠ” ê²ƒë“¤)
                    upcomingAndWeekendCount++;
                }
            });
            
            // 'ì „ì²´ ì¶•ì œ ìˆ˜'ëŠ” ì§„í–‰ì¤‘ + (ë¯¸ë˜ì˜ ì§„í–‰ì¤‘ ë˜ëŠ” ì˜ˆì •)
            // ì¢€ ë” ëª…í™•í•˜ê²ŒëŠ”, ì•„ì§ ì¢…ë£Œë˜ì§€ ì•Šì€ ëª¨ë“  ì¶•ì œ
            const notPastFestivals = rawFestivalData.filter(f => f.dynamicInfo.status !== 'past');
            document.getElementById('total-count').textContent = notPastFestivals.length + 'ê°œ';
            document.getElementById('ongoing-count').textContent = ongoingCount + 'ê°œ';
            
            const regionCounts = rawFestivalData.reduce((acc, fest) => {
                if (fest.region) { // region ì •ë³´ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ ì¹´ìš´íŠ¸
                    acc[fest.region] = (acc[fest.region] || 0) + 1;
                }
                return acc;
            }, {});
            const popular = Object.entries(regionCounts).sort((a,b) => b[1] - a[1]);
            document.getElementById('popular-region').textContent = popular.length > 0 ? popular[0][0] : 'ì •ë³´ ì—†ìŒ';
            
            statsDisplay.style.display = 'block';
        }

        // ì£¼ë§ ì¶•ì œì¸ì§€ íŒë³„í•˜ëŠ” í—¬í¼ í•¨ìˆ˜ (updateStatsìš©)
        function isWeekendFestival(festival, today) {
            if (!festival.dynamicInfo || !festival.dynamicInfo.startDateObj || !festival.dynamicInfo.endDateObj) return false;

            const dayOfWeek = today.getDay();
            const nextSaturday = new Date(today);
            nextSaturday.setDate(today.getDate() + ((6 - dayOfWeek + 7) % 7));
            const nextSunday = new Date(nextSaturday);
            nextSunday.setDate(nextSaturday.getDate() + 1);

            const festStart = festival.dynamicInfo.startDateObj;
            const festEnd = festival.dynamicInfo.endDateObj;
            return (festStart <= nextSunday && festEnd >= nextSaturday) && festival.dynamicInfo.status !== 'past';
        }
        
        function showError(message) {
            document.getElementById('festival-content').innerHTML = `
                <div class="no-festivals" style="color: #ffdddd; background-color: rgba(0,0,0,0.2); padding: 20px; border-radius: 8px;">
                    âš ï¸ ${message}
                </div>
            `;
            document.getElementById('festival-stats-display').style.display = 'none';
        }
        
        function refreshFestival() {
            loadFestivalData();
        }
        
        function openFestivalDetail(festivalId) {
            const festival = rawFestivalData.find(f => f.id === festivalId);
            if (festival) {
                // ìƒˆ ì°½ìœ¼ë¡œ ê³µì‹ ë§í¬ ì—´ê¸° (ì¡´ì¬í•˜ëŠ” ê²½ìš°)
                if (festival.officialLink && festival.officialLink !== '#') {
                    window.open(festival.officialLink, '_blank');
                } else {
                    alert(`ì¶•ì œëª…: ${festival.title}\nì§€ì—­: ${festival.region}\n(ê³µì‹ í™ˆí˜ì´ì§€ ì •ë³´ ì—†ìŒ)`);
                }
            } else {
                alert('ì¶•ì œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            console.log('ì„ íƒëœ ì¶•ì œ ID:', festivalId);
        }
    </script>
</body>
</html>
