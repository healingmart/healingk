// api/all_tourism.js

const AREA_CODES = {
    'ì„œìš¸': 1, 'ë¶€ì‚°': 6, 'ì œì£¼': 39, 'ê°•ë¦‰': 32,
    'ì „ì£¼': 37, 'ëŒ€êµ¬': 4, 'ê´‘ì£¼': 5, 'ëŒ€ì „': 3,
    'ì¸ì²œ': 2, 'ìš¸ì‚°': 7, 'ê²½ì£¼': 35, 'ì¶˜ì²œ': 32
};

const CONTENT_TYPES = {
    festivals: 15,
    accommodation: 32,
    restaurants: 39,
    culture: 14,
    attractions: 12,
    all: 'all'
};

export default async function handler(req, res) {
    // CORS ì„¤ì •
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'GET, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

    if (req.method === 'OPTIONS') {
        return res.status(200).end();
    }

    try {
        const startTime = Date.now();
        const { 
            region = 'ì„œìš¸', 
            type = 'festivals', 
            detail = 'basic',
            numOfRows = 50 
        } = req.query;

        console.log('ğŸš€ í†µí•© ê´€ê´‘ API ì‹œì‘');
        console.log(`ğŸ“ ì§€ì—­: ${region}`);
        console.log(`ğŸ·ï¸ íƒ€ì…: ${type}`);

        // API í‚¤ í™•ì¸
        const possibleKeys = [
            process.env.TOURISM_API_KEY,
            process.env.TOUR_API_KEY,
            process.env.JEONBUK_API_KEY,
            process.env.WEATHER_API_KEY,
            process.env.REGIONAL_API_KEY
        ];

        const apiKey = possibleKeys.find(key => key);
        
        if (!apiKey) {
            return res.status(200).json({
                success: false,
                message: 'API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤',
                data: {}
            });
        }

        console.log('âœ… API í‚¤ í™•ì¸ë¨');

        let result = {};

        if (type === 'all') {
            // ì „ì²´ íƒ€ì… ìˆ˜ì§‘
            console.log('ğŸŒ ì „ì²´ íƒ€ì… ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘...');
            const types = ['festivals', 'accommodation', 'restaurants', 'culture', 'attractions'];
            
            for (const t of types) {
                console.log(`ğŸ”„ ${t} ìˆ˜ì§‘ ì¤‘...`);
                result[t] = await fetchTourismData(apiKey, region, t, Math.floor(numOfRows / 5));
                await sleep(300);
            }
        } else {
            // ë‹¨ì¼ íƒ€ì… ìˆ˜ì§‘
            console.log(`ğŸ¯ ${type} ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘...`);
            result[type] = await fetchTourismData(apiKey, region, type, numOfRows);
        }

        const responseTime = Date.now() - startTime;

        return res.status(200).json({
            success: true,
            data: result,
            meta: {
                region: region,
                type: type,
                detailLevel: detail,
                totalCount: getTotalCount(result),
                responseTime: `${responseTime}ms`,
                timestamp: new Date().toISOString()
            },
            message: `âœ… ${region} ${type} í†µí•© ê´€ê´‘ ì •ë³´ ${getTotalCount(result)}ê°œ ìˆ˜ì§‘ ì™„ë£Œ`
        });

    } catch (error) {
        console.error('âŒ í†µí•© ê´€ê´‘ API ì˜¤ë¥˜:', error);
        return res.status(500).json({
            success: false,
            error: error.message,
            message: 'í†µí•© ê´€ê´‘ ì •ë³´ ìˆ˜ì§‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
            timestamp: new Date().toISOString()
        });
    }
}

// ê´€ê´‘ ë°ì´í„° ìˆ˜ì§‘
async function fetchTourismData(apiKey, region, type, numOfRows) {
    try {
        const areaCode = AREA_CODES[region] || 1;
        const contentTypeId = CONTENT_TYPES[type] || 15;

        console.log(`ğŸ” ${region} (${areaCode}) ${type} (${contentTypeId}) ìˆ˜ì§‘...`);

        const url = 'https://apis.data.go.kr/B551011/KorService2/areaBasedList2';
        const params = new URLSearchParams({
            serviceKey: apiKey,
            numOfRows: Math.min(numOfRows, 100),
            pageNo: 1,
            MobileOS: 'ETC',
            MobileApp: 'HealingK',
            _type: 'json',
            contentTypeId: contentTypeId,
            areaCode: areaCode,
            arrange: 'D'
        });

        const response = await fetch(`${url}?${params.toString()}`, {
            timeout: 10000
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        
        if (data.response?.header?.resultCode === '0000') {
            const items = data.response.body?.items?.item || [];
            const itemsArray = Array.isArray(items) ? items : [items];
            
            console.log(`âœ… ${type}: ${itemsArray.length}ê°œ ìˆ˜ì§‘ ì™„ë£Œ`);
            
            return itemsArray.map(item => transformData(item, type, contentTypeId));
        } else {
            console.log(`âš ï¸ ${type}: ë°ì´í„° ì—†ìŒ (${data.response?.header?.resultMsg})`);
            return [];
        }

    } catch (error) {
        console.error(`âŒ ${type} ìˆ˜ì§‘ ì˜¤ë¥˜:`, error);
        return [];
    }
}

// ë°ì´í„° ë³€í™˜
function transformData(item, type, contentTypeId) {
    const baseData = {
        id: item.contentid,
        title: item.title || 'ì œëª© ì—†ìŒ',
        location: item.addr1 || 'ì£¼ì†Œ ì—†ìŒ',
        region: getRegionFromAddr(item.addr1),
        tel: item.tel || '',
        contentTypeId: contentTypeId,
        contentType: type,
        mapx: item.mapx,
        mapy: item.mapy,
        image: item.firstimage || null,
        thumbnail: item.firstimage2 || null,
        createdtime: item.createdtime,
        modifiedtime: item.modifiedtime,
        mlevel: item.mlevel || '1',
        zipcode: item.zipcode || '',
        originalData: {
            source: 'korean_tourism_organization',
            contentType: type,
            isRealData: true
        }
    };

    // íƒ€ì…ë³„ íŠ¹í™” ë°ì´í„°
    switch (contentTypeId) {
        case '15': // ì¶•ì œ
            return {
                ...baseData,
                category: 'festivals',
                eventStartDate: item.eventstartdate || '',
                eventEndDate: item.eventenddate || '',
                status: calculateEventStatus(item.eventstartdate, item.eventenddate),
                daysLeft: calculateDaysLeft(item.eventstartdate, item.eventenddate)
            };

        case '32': // ìˆ™ë°•
            return {
                ...baseData,
                category: 'accommodation',
                accommodationType: getAccommodationType(item.title),
                benikia: item.benikia || 'N',
                goodstay: item.goodstay || 'N',
                hanok: item.hanok || 'N'
            };

        case '39': // ìŒì‹ì 
            return {
                ...baseData,
                category: 'restaurants',
                foodType: getFoodType(item.title),
                treatmenu: item.treatmenu || '',
                smoking: item.smoking || '',
                packing: item.packing || ''
            };

        case '14': // ë¬¸í™”ì‹œì„¤
            return {
                ...baseData,
                category: 'culture',
                facilityType: 'culture',
                scale: item.scale || '',
                accomcount: item.accomcount || ''
            };

        case '12': // ê´€ê´‘ì§€
            return {
                ...baseData,
                category: 'attractions',
                attractionType: 'tourism',
                heritage1: item.heritage1 || '',
                heritage2: item.heritage2 || '',
                heritage3: item.heritage3 || ''
            };

        default:
            return baseData;
    }
}

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
function getAccommodationType(title) {
    if (title.includes('í˜¸í…”')) return 'hotel';
    if (title.includes('íœì…˜')) return 'pension';
    if (title.includes('ëª¨í…”')) return 'motel';
    if (title.includes('ë¦¬ì¡°íŠ¸')) return 'resort';
    if (title.includes('í•œì˜¥')) return 'hanok';
    return 'etc';
}

function getFoodType(title) {
    if (title.includes('í•œì‹')) return 'korean';
    if (title.includes('ì¤‘ì‹')) return 'chinese';
    if (title.includes('ì¼ì‹')) return 'japanese';
    if (title.includes('ì–‘ì‹')) return 'western';
    if (title.includes('ì¹´í˜')) return 'cafe';
    return 'etc';
}

function calculateEventStatus(startDate, endDate) {
    if (!startDate || !endDate) return 'unknown';
    
    try {
        const now = new Date();
        const start = new Date(startDate.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'));
        const end = new Date(endDate.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'));
        
        if (now < start) return 'upcoming';
        if (now > end) return 'ended';
        return 'ongoing';
    } catch (error) {
        return 'unknown';
    }
}

function calculateDaysLeft(startDate, endDate) {
    if (!startDate || !endDate) return 'ë‚ ì§œ ë¯¸ì •';
    
    try {
        const now = new Date();
        const start = new Date(startDate.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'));
        const end = new Date(endDate.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'));
        
        if (now < start) {
            const diff = Math.ceil((start - now) / (1000 * 60 * 60 * 24));
            return `${diff}ì¼ í›„ ì‹œì‘`;
        }
        if (now > end) {
            return 'ì¢…ë£Œë¨';
        }
        const diff = Math.ceil((end - now) / (1000 * 60 * 60 * 24));
        return `${diff}ì¼ ë‚¨ìŒ`;
    } catch (error) {
        return 'ë‚ ì§œ ë¯¸ì •';
    }
}

function getTotalCount(result) {
    let total = 0;
    for (const key in result) {
        if (Array.isArray(result[key])) {
            total += result[key].length;
        }
    }
    return total;
}

function getRegionFromAddr(addr) {
    if (!addr) return 'ê¸°íƒ€';
    
    const regions = Object.keys(AREA_CODES);
    for (const region of regions) {
        if (addr.includes(region)) {
            return region;
        }
    }
    return 'ê¸°íƒ€';
}

function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}
