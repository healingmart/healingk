<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관광 정보 API 테스트</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"], select, textarea {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tourism API Test - healingk.vercel.app</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; text-align: center; margin-bottom: 30px; }
        button { padding: 12px 24px; margin: 8px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .status { padding: 15px; margin: 15px 0; border-radius: 5px; font-weight: bold; }
        .loading { background: #fff3cd; color: #856404; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .category { margin: 20px 0; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
        .category-header { background: #007bff; color: white; padding: 15px; font-weight: bold; display: flex; justify-content: space-between; }
        .items { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; padding: 20px; }
        .item { border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: white; transition: transform 0.2s; }
        .item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .item img { width: 100%; height: 180px; object-fit: cover; }
        .item-content { padding: 15px; }
        .item-title { font-weight: bold; margin-bottom: 8px; color: #333; }
        .item-addr { color: #666; font-size: 0.9em; margin-bottom: 5px; }
        .item-id { color: #999; font-size: 0.8em; }
        .loading-spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h1>🏛️ 한국관광공사 API 테스트</h1>
        
        <div style="text-align: center; margin: 20px 0;">
            <button onclick="testHealth()">❤️ 헬스체크</button>
            <button onclick="loadAll()">🏛️ 전체 카테고리 로드 (각 30개)</button>
            <button onclick="testSingle()">🧪 단일 테스트</button>
            <button onclick="clear()">🗑️ 지우기</button>
        </div>
        
        <div id="status" style="display:none;"></div>
        <div id="results"></div>
    </div>

    <script>
        // API 엔드포인트: healingk.vercel.app에 배포된 서버리스 함수 경로
        // 현재 브라우저에서 직접 테스트하는 경우, 백엔드 서버가 CORS를 허용해야 합니다.
        const API_BASE_URL = 'https://healingk.vercel.app/api/tourism'; 

        const categories = [
            {id:'12', name:'관광지', icon:'🏛️'},
            {id:'14', name:'문화시설', icon:'🎭'},
            {id:'15', name:'축제/공연/행사', icon:'🎪'},
            {id:'25', name:'여행코스', icon:'🗺️'},
            {id:'28', name:'레포츠', icon:'⛷️'},
            {id:'32', name:'숙박', icon:'🏨'},
            {id:'38', name:'쇼핑', icon:'🛍️'},
            {id:'39', name:'음식점', icon:'🍽️'}
        ];

        function status(msg, type='loading') {
            const div = document.getElementById('status');
            div.innerHTML = msg;
            div.className = `status ${type}`;
            div.style.display = 'block';
        }

        async function call(params) {
            const url = new URL(API_BASE_URL); 
            // operation 파라미터를 다른 쿼리 파라미터와 함께 URLSearchParams에 추가
            Object.entries(params).forEach(([k,v]) => {
                if (v !== undefined && v !== null && String(v).trim() !== '') {
                    url.searchParams.set(k, v);
                }
            });
            
            const res = await fetch(url.toString());
            
            let data;
            try {
                data = await res.json();
            } catch (e) {
                // JSON 파싱 실패 시, 원시 응답 텍스트를 오류 메시지에 포함
                const text = await res.text();
                throw new Error(`JSON 파싱 오류: ${e.message}. 응답 내용: ${text.substring(0, 200)}... `);
            }
            
            // 백엔드 응답 구조에 맞춰 에러 처리: success 필드가 false이고 error 객체가 있는 경우
            if (data.success === false && data.error) {
                const errorMessage = data.error.message || `알 수 없는 오류 (HTTP 상태: ${res.status}, 코드: ${data.error.code}) `;
                throw new Error(errorMessage);
            } else if (!res.ok) { // HTTP 상태 코드가 200이 아닌 경우 (success: true인데 res.ok가 false인 특이 케이스 대비)
                const errorMessage = `HTTP 오류: ${res.status} ${res.statusText}. 메시지: ${data.error?.message || JSON.stringify(data) [cite: 270, 294]}`;
                throw new Error(errorMessage);
            }
            return data;
        }

        async function testHealth() {
            status('<span class="loading-spinner"></span>헬스체크 중... ');
            try {
                // G3.txt의 헬스체크 엔드포인트는 operation 파라미터를 'healthCheck'로 받습니다. 
                const data = await call({ operation: 'healthCheck' });
                // G3.txt의 healthCheck 응답 구조는 data.checks.apiKeyConfigured 입니다. 
                const apiKeyConfigured = data.data?.checks?.apiKeyConfigured; 
                status(`✅ 연결 성공! API 키: ${apiKeyConfigured ? '설정됨' : '누락'}. 상태: ${data.data?.status}. 버전: ${data.data?.version}. `, 'success');
            } catch (e) {
                status(`❌ 헬스체크 실패: ${e.message}`, 'error');
            }
        }

        async function testSingle() {
            status('<span class="loading-spinner"></span>단일 테스트 중... ');
            try {
                // contentTypeId '12' (관광지)에 대해 5개 항목 요청 
                const data = await call({ operation: 'areaBasedList', contentTypeId: '12', numOfRows: '5' });
                // G3.txt의 areaBasedList 성공 응답 구조는 data.data.response.body.items.item 입니다. 
                const items = data.data?.response?.body?.items?.item || []; 
                const totalCount = data.data?.response?.body?.totalCount || 0; 
                
                status(`✅ 단일 테스트 성공! ${items.length}개 아이템 로드됨. `, 'success');
                showCategory({id:'12', name:'관광지 (단일 테스트)', icon:'🧪'}, items, totalCount);
            } catch (e) {
                status(`❌ 단일 테스트 실패: ${e.message}`, 'error');
            }
        }

        async function loadAll() {
            document.getElementById('results').innerHTML = '';
            status('<span class="loading-spinner"></span>모든 카테고리 로딩 중... ');
            
            let totalItemsLoaded = 0;
            let successfulCategories = 0;
            
            for(let i = 0; i < categories.length; i++) {
                const cat = categories[i];
                status(`<span class="loading-spinner"></span>${i+1}/${categories.length} ${cat.name} 로딩 중... `);
                
                try {
                    const data = await call({
                        operation: 'areaBasedList', // 
                        contentTypeId: cat.id, // 
                        numOfRows: '30' // 
                    });
                    
                    // G3.txt의 응답 구조에 맞춰 아이템 및 총 개수 추출 
                    const items = data.data?.response?.body?.items?.item || []; 
                    const totalCount = data.data?.response?.body?.totalCount || 0; 
                    
                    showCategory(cat, items, totalCount);
                    totalItemsLoaded += items.length;
                    successfulCategories++;
                    
                    // 요청 간격 조절 (API 과부하 방지)
                    if(i < categories.length - 1) await new Promise(r => setTimeout(r, 400)); 
                } catch(e) {
                    showError(cat, e.message);
                }
            }
            
            status(`✅ 완료! ${successfulCategories}/${categories.length} 카테고리에서 총 ${totalItemsLoaded}개 데이터 로드 `, 'success');
        }

        function showCategory(cat, items, totalCount) {
            const div = document.createElement('div');
            div.className = 'category';
            div.innerHTML = `
                <div class="category-header">
                    <span>${cat.icon} ${cat.name}</span>
                    <span>${items.length}개 / 전체 ${totalCount}개</span>
                </div>
                <div class="items">
                    ${items.map(item => `
                        <div class="item">
                            <img src="${item.firstimage || 'https://via.placeholder.com/280x180?text=이미지+없음'}" 
                                 onerror="this.src='https://via.placeholder.com/280x180?text=이미지+없음'">
                            <div class="item-content">
                                <div class="item-title">${item.title || '제목없음'}</div>
                                <div class="item-addr">📍 ${item.addr1 || '주소없음'}</div>
                                <div class="item-id">ID: ${item.contentid}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('results').appendChild(div);
        }

        function showError(cat, error) {
            const div = document.createElement('div');
            div.className = 'category';
            div.innerHTML = `
                <div class="category-header">
                    <span>${cat.icon} ${cat.name}</span>
                    <span style="color: #ffcdd2;">오류 발생</span>
                </div>
                <div style="padding:20px; color:#721c24; background:#f8d7da;">❌ ${error}</div>
            `;
            document.getElementById('results').appendChild(div);
        }

        function clear() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('status').style.display = 'none';
        }

        // 페이지 로드시 자동 헬스체크
        window.onload = () => testHealth();
    </script>
</body>
</html>
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover { background-color: #0056b3; }
        pre {
            background-color: #e9e9e9;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
        }
        .section { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .section:last-child { border-bottom: none; }
        .error { color: red; font-weight: bold; }
        .success { color: green; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>관광 정보 API 테스트 클라이언트</h1>

        <div class="section">
            <h2>API 엔드포인트 설정</h2>
            <label for="apiEndpoint">API URL:</label>
            <input type="text" id="apiEndpoint" value="YOUR_SERVERLESS_FUNCTION_URL_HERE" placeholder="예: https://your-vercel-project.vercel.app/api/tourism">
            <p style="font-size: 0.9em; color: #777;">실제 배포된 서버리스 함수의 URL을 입력하세요.</p>
        </div>

        <div class="section">
            <h2>1. 지역 기반 관광 정보 조회 (GET) - areaBasedList</h2>
            <label for="areaCode">지역 코드 (areaCode):</label>
            <input type="text" id="areaCode" value="1" placeholder="예: 1 (서울), 31 (경기도)">
            <label for="contentTypeIdArea">콘텐츠 타입 ID (contentTypeId):</label>
            <input type="text" id="contentTypeIdArea" value="12" placeholder="예: 12 (관광지)">
            <label for="numOfRowsArea">한 페이지 결과 수 (numOfRows):</label>
            <input type="number" id="numOfRowsArea" value="5">
            <label for="pageNoArea">페이지 번호 (pageNo):</label>
            <input type="number" id="pageNoArea" value="1">
            <button onclick="callAreaBasedList()">areaBasedList 호출 (GET)</button>
        </div>

        <div class="section">
            <h2>2. 공통 정보 조회 (POST) - detailCommon</h2>
            <label for="contentIdCommon">콘텐츠 ID (contentId):</label>
            <input type="text" id="contentIdCommon" value="126508" placeholder="예: 126508 (경복궁)">
            <label for="contentTypeIdCommon">콘텐츠 타입 ID (contentTypeId):</label>
            <input type="text" id="contentTypeIdCommon" value="12" placeholder="예: 12 (관광지)">
            <button onclick="callDetailCommon()">detailCommon 호출 (POST)</button>
        </div>

        <div class="section">
            <h2>3. 키워드 검색 (POST) - searchKeyword</h2>
            <label for="keyword">키워드 (keyword):</label>
            <input type="text" id="keyword" value="서울 N 타워">
            <label for="areaCodeKeyword">지역 코드 (areaCode):</label>
            <input type="text" id="areaCodeKeyword" value="1" placeholder="비워두면 전국 검색">
            <button onclick="callSearchKeyword()">searchKeyword 호출 (POST)</button>
        </div>
        
        <div class="section">
            <h2>4. 배치 요청 (POST) - batch</h2>
            <label for="batchOperations">배치 작업 목록 (JSON 형식):</label>
            <textarea id="batchOperations" rows="10" placeholder='[{"operation": "areaCode", "params": {"numOfRows": "2"}}, {"operation": "detailCommon", "params": {"contentId": "264305", "contentTypeId": "12"}}]'>[{"operation": "areaCode", "params": {"numOfRows": "2"}}, {"operation": "detailCommon", "params": {"contentId": "264305", "contentTypeId": "12"}}]</textarea>
            <button onclick="callBatchRequest()">batch 요청 (POST)</button>
        </div>

        <div class="section">
            <h2>5. 헬스 체크 (GET) - healthCheck</h2>
            <button onclick="callHealthCheck()">healthCheck 호출 (GET)</button>
        </div>

        <div class="section">
            <h2>6. 메트릭 조회 (GET) - metrics</h2>
            <button onclick="callMetrics()">metrics 호출 (GET - JSON)</button>
            <button onclick="callMetrics('text/plain')">metrics 호출 (GET - Prometheus)</button>
        </div>


        <h2>API 응답</h2>
        <pre id="responseOutput">여기에 API 응답이 표시됩니다.</pre>
    </div>

    <script>
        const getApiEndpoint = () => {
            const endpoint = document.getElementById('apiEndpoint').value;
            if (!endpoint || endpoint === "YOUR_SERVERLESS_FUNCTION_URL_HERE") {
                alert("API 엔드포인트 URL을 설정해주세요.");
                return null;
            }
            return endpoint;
        };

        const outputElement = document.getElementById('responseOutput');

        async function callApi(method, operation, params = {}, headers = {'Content-Type': 'application/json'}, body = null) {
            const API_ENDPOINT = getApiEndpoint();
            if (!API_ENDPOINT) return;

            outputElement.textContent = '요청 중...';
            outputElement.className = '';

            let url = API_ENDPOINT;
            let requestOptions = {
                method: method,
                headers: headers
            };

            if (method === 'GET') {
                const queryParams = new URLSearchParams({...params, operation});
                url += `?${queryParams.toString()}`;
            } else if (method === 'POST') {
                requestOptions.body = JSON.stringify({ operation, ...params, ...body });
            }


            try {
                const response = await fetch(url, requestOptions);
                const contentType = response.headers.get("content-type");
                let data;

                if (contentType && contentType.includes("application/json")) {
                    data = await response.json();
                    outputElement.textContent = JSON.stringify(data, null, 2);
                    if (data.success === false || !response.ok) {
                        outputElement.className = 'error';
                    } else {
                        outputElement.className = 'success';
                    }
                } else if (contentType && contentType.includes("text/plain")) {
                    data = await response.text();
                    outputElement.textContent = data;
                    if (!response.ok) {
                        outputElement.className = 'error';
                    } else {
                        outputElement.className = 'success';
                    }
                } else {
                     data = await response.text(); // 예상치 못한 content-type
                     outputElement.textContent = `예상치 못한 Content-Type: ${contentType}\n\n${data}`;
                     outputElement.className = 'error';
                }


            } catch (error) {
                console.error('API 호출 오류:', error);
                outputElement.textContent = `오류 발생: ${error.message}\n\n${error.stack}`;
                outputElement.className = 'error';
            }
        }

        function callAreaBasedList() {
            const params = {
                areaCode: document.getElementById('areaCode').value || undefined,
                contentTypeId: document.getElementById('contentTypeIdArea').value || undefined,
                numOfRows: document.getElementById('numOfRowsArea').value || undefined,
                pageNo: document.getElementById('pageNoArea').value || undefined
            };
            // 빈 값은 undefined로 보내서 백엔드 기본값 사용 유도
            for (const key in params) {
                if (params[key] === '') params[key] = undefined;
            }
            callApi('GET', 'areaBasedList', params);
        }

        function callDetailCommon() {
            const params = {
                contentId: document.getElementById('contentIdCommon').value,
                contentTypeId: document.getElementById('contentTypeIdCommon').value
            };
            callApi('POST', 'detailCommon', {}, {'Content-Type': 'application/json'}, params);
        }

        function callSearchKeyword() {
            const params = {
                keyword: document.getElementById('keyword').value,
                areaCode: document.getElementById('areaCodeKeyword').value || undefined
            };
            if (params.areaCode === '') params.areaCode = undefined;
            callApi('POST', 'searchKeyword', {}, {'Content-Type': 'application/json'}, params);
        }

        function callBatchRequest() {
            try {
                const operationsText = document.getElementById('batchOperations').value;
                const operations = JSON.parse(operationsText); // 입력된 JSON 문자열을 파싱
                // POST 요청 시 body는 operation과 params를 포함하는 객체가 아니라,
                // 백엔드 batchHandler가 예상하는 { operations: [...] } 형태여야 합니다.
                callApi('POST', 'batch', {}, {'Content-Type': 'application/json'}, { operations });
            } catch (e) {
                outputElement.textContent = `배치 작업 목록 JSON 파싱 오류: ${e.message}`;
                outputElement.className = 'error';
            }
        }

        function callHealthCheck() {
            callApi('GET', 'healthCheck');
        }

        function callMetrics(acceptType = 'application/json') {
            const headers = acceptType === 'text/plain' ? { 'Accept': 'text/plain' } : { 'Accept': 'application/json' };
            callApi('GET', 'metrics', {}, headers);
        }

    </script>
</body>
</html>
