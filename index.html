<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tourism API Test - 프로덕션 최종</title>
    <!-- Tailwind CSS 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 커스텀 스피너 애니메이션 */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900">🏛️ 한국관광공사 API 테스트</h1>
            <p class="text-gray-600 mt-2">G3 프로덕션 코드를 테스트하기 위한 클라이언트 페이지입니다.</p>
        </header>

        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
            <div class="flex flex-wrap justify-center items-center gap-4">
                <button onclick="testHealth()" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed">❤️ 헬스체크</button>
                <button onclick="loadAll()" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed">🏛️ 전체 카테고리 로드</button>
                <button onclick="testSingle()" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed">🧪 단일 테스트</button>
                <button onclick="clearResults()" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">🗑️ 지우기</button>
            </div>
        </div>

        <!-- 상태 메시지 표시 영역 -->
        <div id="status-container" class="p-4 mb-6 rounded-lg text-center font-semibold" style="display:none;"></div>

        <!-- 결과 표시 영역 -->
        <div id="results" class="space-y-8"></div>
    </div>

    <script>
        // --- API 엔드포인트 설정 ---
        // 서버리스 환경에서는 각 기능(handler)별로 엔드포인트가 분리되는 것이 일반적입니다.
        // G3 코드의 `handler` 함수는 이 주소로 호출됩니다.
        const TOURISM_API_ENDPOINT = '/api/tourism'; 
        // G3 코드의 `healthCheck` 함수는 이 주소로 호출됩니다. (Vercel 라우팅 설정에 따라 달라질 수 있음)
        const HEALTH_API_ENDPOINT = '/api/healthCheck';

        const categories = [
            {id:'12', name:'관광지', icon:'🏞️'},
            {id:'14', name:'문화시설', icon:'🎭'},
            {id:'15', name:'축제/공연/행사', icon:'🎪'},
            {id:'25', name:'여행코스', icon:'🗺️'},
            {id:'28', name:'레포츠', icon:'⛷️'},
            {id:'32', name:'숙박', icon:'🏨'},
            {id:'38', name:'쇼핑', icon:'🛍️'},
            {id:'39', name:'음식점', icon:'🍽️'}
        ];
        
        const statusContainer = document.getElementById('status-container');
        const resultsContainer = document.getElementById('results');
        const buttons = document.querySelectorAll('button');

        /**
         * 버튼 활성/비활성 상태를 제어합니다.
         * @param {boolean} isLoading - 로딩 중 여부
         */
        function setButtonsLoading(isLoading) {
            buttons.forEach(button => {
                button.disabled = isLoading;
            });
        }

        /**
         * 상태 메시지를 표시합니다.
         * @param {string} msg - 표시할 메시지 (HTML 가능)
         * @param {'loading'|'success'|'error'} type - 메시지 종류
         */
        function showStatus(msg, type = 'loading') {
            statusContainer.style.display = 'block';
            let bgColor, textColor;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-100';
                    textColor = 'text-green-800';
                    break;
                case 'error':
                    bgColor = 'bg-red-100';
                    textColor = 'text-red-800';
                    break;
                default: // loading
                    bgColor = 'bg-blue-100';
                    textColor = 'text-blue-800';
                    break;
            }
            statusContainer.className = `p-4 mb-6 rounded-lg text-center font-semibold ${bgColor} ${textColor}`;
            statusContainer.innerHTML = `<div class="flex justify-center items-center">${msg}</div>`;
        }

        /**
         * 범용 API 호출 함수입니다.
         * @param {string} endpoint - 호출할 API 엔드포인트
         * @param {object} params - 쿼리 파라미터로 전송할 객체
         * @returns {Promise<any>} - API 응답 데이터
         */
        async function callApi(endpoint, params = {}) {
            const url = new URL(endpoint, location.origin);
            Object.entries(params).forEach(([key, value]) => {
                if (value !== undefined && value !== null) {
                    url.searchParams.set(key, value);
                }
            });

            const response = await fetch(url);
            const data = await response.json();

            if (!response.ok || !data.success) {
                // 서버에서 보낸 에러 메시지를 우선적으로 사용
                throw new Error(data.error?.message || `HTTP Error ${response.status}`);
            }
            return data;
        }
        
        /**
         * 헬스체크 API를 테스트합니다.
         */
        async function testHealth() {
            clearResults();
            setButtonsLoading(true);
            showStatus('<div class="loading-spinner w-5 h-5 border-blue-500 border-t-transparent border-2 rounded-full mr-3"></div>헬스체크 중...');
            try {
                // 수정: 'healthCheck' 엔드포인트를 직접 호출합니다.
                const data = await callApi(HEALTH_API_ENDPOINT);
                const checks = data.checks;
                const statusMessage = `✅ 헬스체크 성공! | API 키: ${checks.apiKeyConfigured ? 'OK' : '누락!'} | 컨테이너: ${checks.serviceContainerInitialized ? 'OK' : '실패!'}`;
                showStatus(statusMessage, 'success');
            } catch (e) {
                showStatus(`❌ 연결 실패: ${e.message}`, 'error');
            } finally {
                setButtonsLoading(false);
            }
        }

        /**
         * 단일 카테고리를 테스트합니다.
         */
        async function testSingle() {
            clearResults();
            setButtonsLoading(true);
            showStatus('<div class="loading-spinner w-5 h-5 border-indigo-500 border-t-transparent border-2 rounded-full mr-3"></div>단일 테스트 중...');
            try {
                const data = await callApi(TOURISM_API_ENDPOINT, { operation: 'areaBasedList', contentTypeId: '12', numOfRows: '5' });
                const items = data.data?.response?.body?.items?.item || [];
                showStatus(`✅ 단일 테스트 성공! ${items.length}개 아이템 로드`, 'success');
                showCategory({id:'12', name:'관광지 테스트', icon:'🏞️'}, items, data.data.response.body.totalCount);
            } catch (e) {
                showStatus(`❌ 단일 테스트 실패: ${e.message}`, 'error');
            } finally {
                setButtonsLoading(false);
            }
        }

        /**
         * 모든 카테고리의 데이터를 로드합니다.
         */
        async function loadAll() {
            clearResults();
            setButtonsLoading(true);
            let totalItems = 0;
            let successCount = 0;

            for (let i = 0; i < categories.length; i++) {
                const cat = categories[i];
                showStatus(`<div class="loading-spinner w-5 h-5 border-green-500 border-t-transparent border-2 rounded-full mr-3"></div>(${i+1}/${categories.length}) ${cat.name} 로딩 중...`);
                
                try {
                    const data = await callApi(TOURISM_API_ENDPOINT, {
                        operation: 'areaBasedList',
                        contentTypeId: cat.id,
                        numOfRows: '30'
                    });
                    
                    const items = data.data?.response?.body?.items?.item || [];
                    const totalCount = data.data?.response?.body?.totalCount || 0;
                    showCategory(cat, items, totalCount);
                    totalItems += items.length;
                    successCount++;

                    // API Rate Limit을 피하기 위해 요청 간 딜레이 추가
                    if (i < categories.length - 1) await new Promise(r => setTimeout(r, 200));
                } catch(e) {
                    showError(cat, e.message);
                }
            }
            
            showStatus(`✅ 로드 완료! ${successCount}/${categories.length}개 카테고리에서 총 ${totalItems}개 데이터 로드`, 'success');
            setButtonsLoading(false);
        }

        /**
         * 카테고리별 결과를 화면에 표시합니다.
         * @param {object} cat - 카테고리 정보
         * @param {Array} items - 아이템 목록
         * @param {number} totalCount - 전체 아이템 수
         */
        function showCategory(cat, items, totalCount) {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'category bg-white rounded-xl shadow-md overflow-hidden';
            
            const itemsHtml = items.map(item => `
                <div class="item border border-gray-200 rounded-lg overflow-hidden bg-white hover:shadow-lg transition-shadow duration-300">
                    <img src="${item.firstimage || 'https://placehold.co/400x250/E2E8F0/A0AEC0?text=No+Image'}" 
                         onerror="this.onerror=null;this.src='https://placehold.co/400x250/E2E8F0/A0AEC0?text=Error';" 
                         class="w-full h-48 object-cover" alt="${item.title || ''}">
                    <div class="p-4">
                        <div class="font-bold text-lg mb-2 truncate" title="${item.title || ''}">${item.title || '제목없음'}</div>
                        <p class="text-gray-600 text-sm mb-2 truncate">📍 ${item.addr1 || '주소없음'}</p>
                        <p class="text-gray-500 text-xs">ID: ${item.contentid}</p>
                    </div>
                </div>
            `).join('');

            categoryDiv.innerHTML = `
                <div class="category-header bg-gray-800 text-white p-4 flex justify-between items-center">
                    <h2 class="text-xl font-bold">${cat.icon} ${cat.name}</h2>
                    <span class="text-sm bg-gray-600 px-2 py-1 rounded-full">${items.length} / ${totalCount}</span>
                </div>
                <div class="items p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                    ${itemsHtml || '<p class="col-span-full text-center text-gray-500 py-8">데이터가 없습니다.</p>'}
                </div>
            `;
            resultsContainer.appendChild(categoryDiv);
        }

        /**
         * 오류 발생 시 오류 메시지를 화면에 표시합니다.
         * @param {object} cat - 카테고리 정보
         * @param {string} errorMsg - 에러 메시지
         */
        function showError(cat, errorMsg) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'category bg-red-50 rounded-xl shadow-md overflow-hidden';
            errorDiv.innerHTML = `
                <div class="category-header bg-red-700 text-white p-4 flex justify-between items-center">
                    <h2 class="text-xl font-bold">${cat.icon} ${cat.name}</h2>
                    <span class="text-sm bg-red-500 px-2 py-1 rounded-full">오류 발생</span>
                </div>
                <div class="p-4 text-red-800 font-semibold">
                    ❌ ${errorMsg}
                </div>
            `;
            resultsContainer.appendChild(errorDiv);
        }

        /**
         * 결과 영역과 상태 메시지를 초기화합니다.
         */
        function clearResults() {
            resultsContainer.innerHTML = '';
            statusContainer.style.display = 'none';
        }

        // 페이지 로드 시 자동으로 헬스체크 실행
        window.onload = () => testHealth();

    </script>
</body>
</html>
